<!doctype html><html><head><meta http-equiv=Content-Type content="text/html; charset=utf-8"><meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta name=msapplication-TileColor content=#FFFFFF><meta name=msapplication-TileImage content=http://docs.kuzzle.io/assets/images/favicon/mstile-144x144.png><meta name=msapplication-square70x70logo content=http://docs.kuzzle.io/assets/images/favicon/mstile-70x70.png><meta name=msapplication-square150x150logo content=http://docs.kuzzle.io/assets/images/favicon/mstile-150x150.png><meta name=msapplication-wide310x150logo content=http://docs.kuzzle.io/assets/images/favicon/mstile-310x150.png><meta name=msapplication-square310x310logo content=http://docs.kuzzle.io/assets/images/favicon/mstile-310x310.png><meta name=google-site-verification content=luspUdq52gkUU0FFChQ2xmeXSs5HDafpARQ7fVXVBp4><meta itemprop=name content="Advanced Roles Definitions"><meta itemprop=image content=http://docs.kuzzle.io/assets/images/favicon/favicon-196x196.png><meta name=twitter:card value=summary><meta name=twitter:site content=@kuzzleio><meta name=twitter:title content="Advanced Roles Definitions"><meta name=twitter:creator content=@kuzzleio><meta name=twitter:image content=http://docs.kuzzle.io/assets/images/favicon/favicon-196x196.png><meta property=og:title content="Advanced Roles Definitions"><meta property=og:type content=article><meta property=og:site_name content=""><meta property=og:image content=http://docs.kuzzle.io/assets/images/favicon/favicon-96x96.png><meta property=article:published_time content=2017-07-04T09:44:24.198Z><meta property=article:modified_time content=2017-07-04T09:44:24.198Z><meta property=article:section content=Guide><meta property=article:tag content="Kuzzle in depth"><link rel=apple-touch-icon-precomposed sizes=57x57 href=/assets/images/favicon/apple-touch-icon-57x57.png><link rel=apple-touch-icon-precomposed sizes=114x114 href=/assets/images/favicon/apple-touch-icon-114x114.png><link rel=apple-touch-icon-precomposed sizes=72x72 href=/assets/images/favicon/apple-touch-icon-72x72.png><link rel=apple-touch-icon-precomposed sizes=144x144 href=/assets/images/favicon/apple-touch-icon-144x144.png><link rel=apple-touch-icon-precomposed sizes=60x60 href=/assets/images/favicon/apple-touch-icon-60x60.png><link rel=apple-touch-icon-precomposed sizes=120x120 href=/assets/images/favicon/apple-touch-icon-120x120.png><link rel=apple-touch-icon-precomposed sizes=76x76 href=/assets/images/favicon/apple-touch-icon-76x76.png><link rel=apple-touch-icon-precomposed sizes=152x152 href=/assets/images/favicon/apple-touch-icon-152x152.png><link rel=icon type=image/png href=/assets/images/favicon/favicon-196x196.png sizes=196x196><link rel=icon type=image/png href=/assets/images/favicon/favicon-96x96.png sizes=96x96><link rel=icon type=image/png href=/assets/images/favicon/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/assets/images/favicon/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/assets/images/favicon/favicon-128.png sizes=128x128><link rel=stylesheet href=/assets/font-awesome/scss/font-awesome.css><link href="//fonts.googleapis.com/css?family=Ubuntu:400,500,700" rel=stylesheet><title>Advanced Roles Definitions - Kuzzle in depth - Guide - Kuzzle documentation</title><link rel=stylesheet href=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.7.0/styles/atom-one-light.min.css><link href=/assets/stylesheets/full/screen.css rel=stylesheet type=text/css media=screen></head><body class=index><header><div class=wrapper><div id=logo><a href=http://kuzzle.io/ >&#xA0;</a></div><a class=mobile-nav-burger href=javascript:;></a><nav><ul><li><a href=http://kuzzle.io/kuzzle-entreprise class=nav-item>product</a></li><li><a href=http://docs.kuzzle.io/ class="nav-item developers active">Documentation</a><ul class=mobile-nav><li class=active><a href=/guide><span>Guide</span></a><ul class=sub-nav><li><a href=/guide/getting-started><span>Getting started</span></a></li><li><a href=/guide/essentials><span>Essentials</span></a></li><li><a href=/guide/tutorial><span>Tutorial</span></a></li><li class=active><a href=/guide/kuzzle-depth><span>Kuzzle in depth</span></a></li></ul></li><li><a href=/sdk-reference><span>SDK Reference</span></a></li><li><a href=/kuzzle-dsl><span>Kuzzle DSL</span></a></li><li><a href=/validation-reference><span>Data Validation</span></a></li><li><a href=/api-documentation><span>API Documentation</span></a></li><li><a href=/plugins-reference><span>Plugins Reference</span></a></li><li><a href=/kuzzle-events><span>Kuzzle events</span></a></li><li><a href=/elasticsearch-cookbook><span>Elasticsearch Cookbook</span></a></li></ul></li><li><a href=http://kuzzle.io/demos-tutorials/ class=nav-item>Demos</a></li><li><a href=http://kuzzle.io/blog/ class=nav-item>Blog</a></li><li><a href=http://kuzzle.io/contact/ class=nav-item>Contact</a></li><li><a href=http://kuzzle.io/install/ class=nav-item>Try it</a></li><li><a href=https://github.com/kuzzleio/kuzzle target=_blank class="nav-item github"><i class="icon icon-github icon-small"></i></a></li></ul></nav></div><div class="developer-nav open"><ul class=search><li><input name=search type=search placeholder=search tabindex=1></li></ul><ul class=nav><li class=active><a href=/guide><span>Guide</span></a></li><li><a href=/sdk-reference><span>SDK Reference</span></a></li><li><a href=/kuzzle-dsl><span>Kuzzle DSL</span></a></li><li><a href=/validation-reference><span>Data Validation</span></a></li><li><a href=/api-documentation><span>API Documentation</span></a></li><li><a href=/plugins-reference><span>Plugins Reference</span></a></li><li><a href=/kuzzle-events><span>Kuzzle events</span></a></li><li><a href=/elasticsearch-cookbook><span>Elasticsearch Cookbook</span></a></li></ul><div class=search-results><ul></ul></div><script type=text/plain id=search-results-template><li>
        <a href="__link__" tabindex="__tabindex__">
          <p class="page">
            <span class="title">__title__</span>
            <span class="firstMember">__firstMember__</span>
            <span class="parent">__parent__</span>
          </p>
          <p class="preview">__preview__</p>
        </a>
      </li></script></div></header><div class=container><div class=tocify-wrapper><ul class=search-results></ul><div class=tocify><ul class=tocify-header><li class="tocify-item tocify-focus tocify-hover"></li></ul><ul class=tocify-header><li class=tocify-item><a style="color: #111; text-decoration: none" href=http://docs.kuzzle.io/guide title="back to Guide home">Guide</a></li><ul class=tocify-subheader><li class=tocify-item><a style="color: #002835; text-decoration: none" href=/guide/getting-started title="learn kuzzle in a few steps">Getting started</a></li><li class=tocify-item><a style="color: #002835; text-decoration: none" href=/guide/essentials title="learn mechanisms of kuzzle">Essentials</a></li><li class=tocify-item><a style="color: #002835; text-decoration: none" href=/guide/tutorial title="learn kuzzle in a real case">Tutorial</a></li><li class="tocify-item tocify-focus"><a style="color: #FFF; text-decoration: none" href=# title="understand how to extend kuzzle">Kuzzle in depth</a></li><ul class=tocify-header><ul class=tocify-subheader><li class="tocify-item tocify-level-2"><a style="color: #002835; text-decoration: none" href=/guide/kuzzle-depth title="understand how to extend kuzzle">&#x203A; Architecture</a></li><li class="tocify-item tocify-level-2"><a style="color: #002835; text-decoration: none" href=/guide/kuzzle-depth/request-life-cycle title="Request Life-Cycle">&#x203A; Request Life-Cycle</a></li><li class="tocify-item tocify-level-2"><a style="color: #002835; text-decoration: none" href=/guide/kuzzle-depth/authentication title=Authentication>&#x203A; Authentication</a></li><li class="tocify-item tocify-level-2 tocify-focus"><a style="color: #FFF; text-decoration: none" href=/guide/kuzzle-depth/roles-definitions title="Advanced Roles Definitions">&#x203A; Advanced Roles Definitions</a></li></ul></ul></ul></ul><ul class=toc-footer></ul></div></div><div class=page-wrapper><div class=toc><ul><li class="toc-item toc-level-1"><a href=#advanced-roles-definitions title="Advanced Roles Definitions">Advanced Roles Definitions</a></li><li class="toc-item toc-level-2"><a href=#permission-closures title="Permission Closures">Permission Closures</a></li><li class="toc-item toc-level-2"><a href=#the-permission-function title="The permission function">The permission function</a></li><li class="toc-item toc-level-3"><a href=#request title=$request>$request</a></li><li class="toc-item toc-level-3"><a href=#currentuserid title=$currentUserId>$currentUserId</a></li><li class="toc-item toc-level-3"><a href=#args title=args>args</a></li><li class="toc-item toc-level-2"><a href=#the-fetch-definition title="The Fetch Definition">The Fetch Definition</a></li><li class="toc-item toc-level-3"><a href=#args-element-structure title="args element structure">args element structure</a></li><li class="toc-item toc-level-3"><a href=#embedded-variables title="Embedded variables">Embedded variables</a></li><li class="toc-item toc-level-3"><a href=#action-types title="action types">action types</a></li><li class="toc-item toc-level-4"><a href=#get title=get>get</a></li><li class="toc-item toc-level-4"><a href=#mget title=mget>mget</a></li><li class="toc-item toc-level-4"><a href=#search title=search>search</a></li></ul></div><div class=content><div class=mobile-breadcrumb><p style=float:left><a href=http://docs.kuzzle.io/ >Kuzzle documentation</a> &#xBB; <a href=http://docs.kuzzle.io/guide>Guide</a> &#xBB; <a href=http://docs.kuzzle.io/guide/kuzzle-depth>Kuzzle in depth</a> &#xBB; Advanced Roles Definitions</p><p style=float:right class=version-selector><select onchange="window.location = this.value"><option selected>1.0.0</option></select></p></div><div class=nav-sibling><div class=nav-left><p><a href=https://github.com/kuzzleio/documentation/edit/master/src/guide/kuzzle-depth/roles-definitions.md>edit on github<i class="icon icon-github icon-small"></i></a> <span class=separator>|</span> <a href="https://github.com/kuzzleio/documentation/issues/new?labels=guide&amp;title=Feedback%20about%20page%20&apos;guide/kuzzle-depth/roles-definitions.md&apos;">send feedback about this content<i class="icon icon-github icon-small"></i></a> <span class=separator>|</span><select class=rate-documentation><option value=""></option><option value=1>Unusable documentation</option><option value=2>Poor documentation</option><option value=3>OK documentation</option><option value=4>Good documentation</option><option value=5>Excellent documentation</option></select></p></div><div class=nav-right><p class=version-selector><span>current version:</span><select onchange="window.location = this.value"><option selected>1.0.0</option></select></p></div><div style=clear:both></div></div><div class=toc-inline><ul><li class="toc-item toc-level-1"><a href=#advanced-roles-definitions title="Advanced Roles Definitions">Advanced Roles Definitions</a></li><li class="toc-item toc-level-2"><a href=#permission-closures title="Permission Closures">Permission Closures</a></li><li class="toc-item toc-level-2"><a href=#the-permission-function title="The permission function">The permission function</a></li><li class="toc-item toc-level-3"><a href=#request title=$request>$request</a></li><li class="toc-item toc-level-3"><a href=#currentuserid title=$currentUserId>$currentUserId</a></li><li class="toc-item toc-level-3"><a href=#args title=args>args</a></li><li class="toc-item toc-level-2"><a href=#the-fetch-definition title="The Fetch Definition">The Fetch Definition</a></li><li class="toc-item toc-level-3"><a href=#args-element-structure title="args element structure">args element structure</a></li><li class="toc-item toc-level-3"><a href=#embedded-variables title="Embedded variables">Embedded variables</a></li><li class="toc-item toc-level-3"><a href=#action-types title="action types">action types</a></li><li class="toc-item toc-level-4"><a href=#get title=get>get</a></li><li class="toc-item toc-level-4"><a href=#mget title=mget>mget</a></li><li class="toc-item toc-level-4"><a href=#search title=search>search</a></li></ul></div><div class=main-content><h1><a class=anchor id=advanced-roles-definitions></a>Advanced Roles Definitions</h1><p>In the <a href=/guide/essentials/security/#permissions>User Guide</a>, we have seen how to assign basic roles to profiles and profiles to users. Here, we are going to learn how to set complex and dynamic permissions.</p><p>The privileges for a certain action (restricted to a given set of indexes and collections) must be expressed as a boolean value. So far, we hard-coded this value within the permissions configuration. In some cases, this will not fit your needs. In a collaborative TO-DO list application, for example, a user should not be allowed to update other user&apos;s items. This need is addressed by what we call Permission Closures.</p><hr><h2><a class=anchor id=permission-closures></a>Permission Closures</h2><p>Instead of hard-coding the permission boolean value, we assign a function (a closure) that computes this value and returns it based on the execution context.</p><p>For example, if we need to allow users to update only their own documents, it can be done with this sample role:</p><pre><code class="hljs javascript"><span class=hljs-keyword>let</span> role = {
  <span class=hljs-attr>controllers</span>: {
    <span class=hljs-attr>write</span>: {
      <span class=hljs-attr>actions</span>: {
        <span class=hljs-attr>update</span>: {
          <span class=hljs-attr>args</span>: {
            <span class=hljs-attr>document</span>: {
              <span class=hljs-attr>index</span>: <span class=hljs-string>&quot;$request.input.resource.index&quot;</span>,
              <span class=hljs-attr>collection</span>: <span class=hljs-string>&quot;$request.input.resource.collection&quot;</span>,
              <span class=hljs-attr>action</span>: {
                <span class=hljs-attr>get</span>: <span class=hljs-string>&quot;$currentId&quot;</span>
              }
            }
          },
          <span class=hljs-attr>test</span>: <span class=hljs-string>&quot;return args.document.content.user.id === $currentUserId&quot;</span>
        }
      }
    }
  }
};</code></pre><p>Where:</p><ul><li><code>test</code> is the body of <a href=/guide/kuzzle-depth/roles-definitions/#the-permission-function>the permission function</a></li><li><code>args</code> is the parameter given to <a href=/guide/kuzzle-depth/roles-definitions/#the-fetch-definition>the fetch definition function</a></li></ul><hr><h2><a class=anchor id=the-permission-function></a>The permission function</h2><p>The permission function is executed in a sandbox with a limited context. Its body is the evaluation of the <code>test</code> parameter given in the role&apos;s definition and <strong>must return a boolean value</strong>.</p><p>The permission function has the following signature:</p><pre><code class="hljs javascript"><span class=hljs-comment>/**
 * @param {Request} $request              The current action request.
 * @param {string} $currentUserId         The current user kuid. Shortcut to request.context.token.userId
 * @param {Object} args                   The result of the evaluated args definition.
 *
 * @return {Boolean}
 */</span>
<span class=hljs-function><span class=hljs-keyword>function</span> (<span class=hljs-params>$request, $currentUserId, args</span>) </span>{
  <span class=hljs-comment>// the function body is built from the &quot;test&quot; parameter.</span>
  <span class=hljs-comment>// Example, with the sample role above:</span>
  <span class=hljs-keyword>return</span> args.document.content.user.id === $currentUserId;
};</code></pre><h3><a class=anchor id=request></a>$request</h3><p>The <a href=https://github.com/kuzzleio/kuzzle-common-objects#request>Request</a> object is the request that is currently being evaluated.</p><h3><a class=anchor id=currentuserid></a>$currentUserId</h3><p>The <code>$currentUserId</code> variable contains the current user <a href=/guide/essentials/user-authentication/#kuzzle-user-identifier-kuid><code>&lt;kuid&gt;</code></a>. It is an alias for <code>request.context.token.userId</code>.</p><h3><a class=anchor id=args></a>args</h3><p>The main purpose of the &quot;closures&quot; behavior is to define a role policy based on the current state of the persistence layer. This means that we need to fetch documents from the storage engine in order to use them within the permission function.</p><p>The <code>args</code> object contains these documents, as a result of the evaluation of the <a href=/guide/kuzzle-depth/roles-definitions/#the-fetch-definition>fetch definition</a>. Each <code>args</code> item will look like:</p><pre><code class="hljs javascript">{
  <span class=hljs-string>&quot;content&quot;</span>: {}, <span class=hljs-comment>// the document itself</span>
  <span class=hljs-string>&quot;id&quot;</span>: <span class=hljs-string>&quot;&lt;document id&gt;&quot;</span>
}</code></pre><p>In the sample role above (<code>return args.document.content.user.id === $currentUserId</code>), the <code>update</code> action is allowed only if the fetched document contains an attribute <code>user.id</code> which value is the current user ID.</p><hr><h2><a class=anchor id=the-fetch-definition></a>The Fetch Definition</h2><p>The Fetch Definition allows you to pass some documents fetched from the persistence layer to your permission function.</p><p>In our sample role above, we fetch a <code>document</code> variable which contains the document that was requested for update, and we use it in the permission function to test if it is owned by the current user.</p><h3><a class=anchor id=args-element-structure></a>args element structure</h3><p>The <code>args</code> element is the place where we define our Fetch Definitions and has the following structure:</p><pre><code class="hljs javascript">{
  <span class=hljs-string>&quot;args&quot;</span>: {
    <span class=hljs-string>&quot;&lt;some variable&gt;&quot;</span>: {
      <span class=hljs-string>&quot;index&quot;</span>: <span class=hljs-string>&quot;&lt;index from which to fetch the document(s)&gt;&quot;</span>,
      <span class=hljs-string>&quot;collection&quot;</span>: <span class=hljs-string>&quot;&lt;collection from which to fetch the document(s)&gt;&quot;</span>,
      <span class=hljs-string>&quot;action&quot;</span>: {
        <span class=hljs-string>&quot;&lt;action type (get|mget|search)&gt;&quot;</span>: {} <span class=hljs-comment>// &lt;action type specific parameters&gt;</span>
      }
    },
    <span class=hljs-string>&quot;&lt;another variable&gt;&quot;</span>: {
      <span class=hljs-comment>// ...</span>
    },
    <span class=hljs-comment>// ...</span>
  }
}</code></pre><p>You can define one or more variables inside the args element and, for each of them, the action to use to populate them. Each variable will then be available in <a href=/guide/kuzzle-depth/roles-definitions/#the-permission-function>your permission function</a> as <code>args.&lt;variable&gt;</code>.</p><h3><a class=anchor id=embedded-variables></a>Embedded variables</h3><p>Some variables are exposed by Kuzzle and can be used within your Fetch Definition:</p><ul><li><code>$request</code>: The complete request object being evaluated.</li><li><code>$currentId</code>: The current request document ID. It is an alias for <code>$request.input.resource._id</code>.</li></ul><h3><a class=anchor id=action-types></a>action types</h3><h4><a class=anchor id=get></a><code>get</code></h4><p>The <code>get</code> action type performs a read/get call. It fetches a document by its ID.</p><p>Example:</p><pre><code class="hljs javascript">{
  <span class=hljs-string>&quot;args&quot;</span>: {
    <span class=hljs-string>&quot;currentDocument&quot;</span>: {
      <span class=hljs-string>&quot;index&quot;</span>: <span class=hljs-string>&quot;$request.input.resource.index&quot;</span>,
      <span class=hljs-string>&quot;collection&quot;</span>: <span class=hljs-string>&quot;$request.input.resource.collection&quot;</span>,
      <span class=hljs-string>&quot;action&quot;</span>: {
        <span class=hljs-string>&quot;get&quot;</span>: <span class=hljs-string>&quot;$currentId&quot;</span>
      }
    },
    <span class=hljs-string>&quot;anotherDocument&quot;</span>: {
      <span class=hljs-string>&quot;index&quot;</span>: <span class=hljs-string>&quot;myIndex&quot;</span>,
      <span class=hljs-string>&quot;collection&quot;</span>: <span class=hljs-string>&quot;myCollection&quot;</span>,
      <span class=hljs-string>&quot;action&quot;</span>: {
        <span class=hljs-string>&quot;get&quot;</span>: <span class=hljs-string>&quot;document_id&quot;</span>
      }
    }
  }
}</code></pre><p>In the <code>args</code> field, we declare the following Fetch Definitions:</p><ul><li><code>currentDocument</code>, which represents the document that the user wants to update and whose Fetch Definition is composed of:<ul><li><code>index</code>: the index pointed by the current Request;</li><li><code>collection</code>: the collection pointed by the current Request;</li><li><code>$currentId</code>: the document ID pointed by the current Request, passed as an argument to the <code>get</code> action.</li></ul></li><li><code>anotherDocument</code>, which represents another document, just as an example, fetched the same way as the previous one but with different parameters.</li></ul><h4><a class=anchor id=mget></a><code>mget</code></h4><p>The <code>mget</code> action type takes a list of document ids for entry and returns the list of matching documents.</p><pre><code class="hljs javascript">{
  <span class=hljs-string>&quot;args&quot;</span>: {
    <span class=hljs-string>&quot;myDocuments&quot;</span>: {
      <span class=hljs-string>&quot;index&quot;</span>: <span class=hljs-string>&quot;myIndex&quot;</span>,
      <span class=hljs-string>&quot;collection&quot;</span>: <span class=hljs-string>&quot;myCollection&quot;</span>,
      <span class=hljs-string>&quot;action&quot;</span>: {
        <span class=hljs-string>&quot;mget&quot;</span>: [
          <span class=hljs-string>&quot;id_1&quot;</span>,
          <span class=hljs-string>&quot;id_2&quot;</span>,
          <span class=hljs-comment>// ...</span>
        ]
      }
    }
  }
}</code></pre><p>In the <code>args</code> field, we declare a multi-valued Fetch Definition. Notice how the <code>mget</code> action takes an array of IDs rather than a single value.</p><p>These documents are accessed in the Permission Function as follows:</p><pre><code class="hljs javascript">args.myDocuments = [
  {
    <span class=hljs-attr>id</span>: <span class=hljs-string>&quot;id_1&quot;</span>, <span class=hljs-attr>content</span>: {<span class=hljs-attr>name</span>: <span class=hljs-string>&quot;Document 1&quot;</span>, <span class=hljs-attr>description</span>: <span class=hljs-string>&quot;Cum sociis natoque penatibus et magnis dis parturient montes&quot;</span>},
  }
  {
    <span class=hljs-attr>id</span>: <span class=hljs-string>&quot;id_2&quot;</span>, <span class=hljs-attr>content</span>: {<span class=hljs-attr>name</span>: <span class=hljs-string>&quot;Document 2&quot;</span>, <span class=hljs-attr>description</span>: <span class=hljs-string>&quot;nascetur ridiculus mus. Nulla nunc velit&quot;</span>},
  }
  ...
]</code></pre><h4><a class=anchor id=search></a><code>search</code></h4><p>The <code>search</code> action type performs a search on the persistence layer and returns the resulting documents. It behave exactly like a normal <a href=/guide/essentials/persisted/#document-search>document search</a>.</p><p>Example:</p><pre><code class="hljs javascript">{
  <span class=hljs-string>&quot;args&quot;</span>: {
    <span class=hljs-string>&quot;myDocuments&quot;</span>: {
      <span class=hljs-string>&quot;index&quot;</span>: <span class=hljs-string>&quot;myIndex&quot;</span>,
      <span class=hljs-string>&quot;collection&quot;</span>: <span class=hljs-string>&quot;myCollection&quot;</span>,
      <span class=hljs-string>&quot;action&quot;</span>: {
        <span class=hljs-string>&quot;search&quot;</span>: {
          <span class=hljs-string>&quot;filter&quot;</span>: {
            <span class=hljs-string>&quot;match&quot;</span>: {
              <span class=hljs-string>&quot;name&quot;</span>: <span class=hljs-string>&quot;$request.input.body.name&quot;</span>
            }
          }
        }
      }
    }
  }  
}</code></pre><p>The search results are available in the Permission Function as an array of documents fetched from <code>myIndex</code>/<code>myCollection</code>, for which the <code>name</code> attribute matches the <code>name</code> attribute of the request:</p><pre><code class="hljs javascript">args.myDocuments = [
  { <span class=hljs-attr>id</span>: <span class=hljs-string>&quot;id_1&quot;</span>, <span class=hljs-attr>content</span>: {<span class=hljs-attr>name</span>: <span class=hljs-string>&quot;foo&quot;</span>, <span class=hljs-attr>description</span>: <span class=hljs-string>&quot;Cum sociis natoque penatibus et magnis dis parturient montes&quot;</span>}},
  { <span class=hljs-attr>id</span>: <span class=hljs-string>&quot;id_2&quot;</span>, <span class=hljs-attr>content</span>: {<span class=hljs-attr>name</span>: <span class=hljs-string>&quot;foo bar&quot;</span>, <span class=hljs-attr>description</span>: <span class=hljs-string>&quot;nascetur ridiculus mus. Nulla nunc velit&quot;</span>}},
  ...
]</code></pre><p>The content of <code>action.search</code> is directly passed to Elasticsearch.</p><p>Please refer to <a href=/elasticsearch-cookbook/ >our Elasticsearch Cookbook</a> for additional information on how to build your query.</p><div style="clear: both"></div></div><hr><div id=disqus_thread></div><script async>var disqus_developer = 1;
      
        var disqus_config = function () {
          this.page.url = 'http://docs.kuzzle.io/guide/kuzzle-depth/roles-definitions';
          this.page.title = 'Advanced Roles Definitions';
          this.page.identifier = 'guide/kuzzle-depth/roles-definitions';
        };
      
        (function() {
          var d = document, s = d.createElement('script');
          s.src = 'https://kuzzle-documentation.disqus.com/embed.js';
          s.async = 'async';
          s.setAttribute('data-timestamp', +new Date());
          (d.head || d.body).appendChild(s);
        })();</script><div class="nav-sibling bottom"><div class=nav-left><p><a href=https://github.com/kuzzleio/documentation/edit/master/src/guide/kuzzle-depth/roles-definitions.md>edit on github<i class="icon icon-github icon-small"></i></a> <span class=separator>|</span> <a href="https://github.com/kuzzleio/documentation/issues/new?labels=guide&amp;title=Feedback%20about%20page%20&apos;guide/kuzzle-depth/roles-definitions.md&apos;">send feedback about this content<i class="icon icon-github icon-small"></i></a> <span class=separator>|</span><select class=rate-documentation><option value=""></option><option value=1>Unusable documentation</option><option value=2>Poor documentation</option><option value=3>OK documentation</option><option value=4>Good documentation</option><option value=5>Excellent documentation</option></select></p></div><div class=nav-right><p class=medium-only></p><p><a href=#>back to top &#x2191;</a></p></div><div style=clear:both></div></div></div></div></div><script src=//ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js></script><script src=//cdn.jsdelivr.net/algoliasearch/3/algoliasearch.min.js></script><script src=//cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.6.0/clipboard.min.js></script><script src=/assets/javascript/lib/jquery.barrating.js></script><script type=text/javascript>// store helper
  var store = function store(key, value) {
    var lsSupport = false;

    // Check for native support
    if (localStorage) {
      lsSupport = true;
    }

    // If value is detected, set new or modify store
    if (typeof value !== "undefined" && value !== null) {
      // Convert object values to JSON
      if ( typeof value === 'object' ) {
        value = JSON.stringify(value);
      }
      // Set the store
      if (lsSupport) { // Native support
        localStorage.setItem(key, value);
      } else { // Use Cookie
        createCookie(key, value, 30);
      }
    }

    // No value supplied, return value
    if (typeof value === "undefined") {
      // Get value
      if (lsSupport) { // Native support
        data = localStorage.getItem(key);
      } else { // Use cookie
        data = readCookie(key);
      }

      // Try to parse JSON...
      try {
        data = JSON.parse(data);
      }
      catch(e) {
        data = data;
      }

      return data;
    }

    // Null specified, remove store
    if (value === null) {
      if (lsSupport) { // Native support
        localStorage.removeItem(key);
      } else { // Use cookie
        createCookie(key, '', -1);
      }
    }

    /**
     * Creates new cookie or removes cookie with negative expiration
     * @param  key       The key or identifier for the store
     * @param  value     Contents of the store
     * @param  exp       Expiration - creation defaults to 30 days
     */
    function createCookie(key, value, exp) {
      var date = new Date();
      date.setTime(date.getTime() + (exp * 24 * 60 * 60 * 1000));
      var expires = "; expires=" + date.toGMTString();
      document.cookie = key + "=" + value + expires + "; path=/";
    }

    /**
     * Returns contents of cookie
     * @param  key       The key or identifier for the store
     */
    function readCookie(key) {
      var nameEQ = key + "=";
      var ca = document.cookie.split(';');
      for (var i = 0, max = ca.length; i < max; i++) {
        var c = ca[i];
        while (c.charAt(0) === ' ') c = c.substring(1, c.length);
        if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
      }
      return null;
    }
  };






  // google analytics
  (function(i, s, o, g, r, a, m) {
      i['GoogleAnalyticsObject'] = r;
      i[r] = i[r] || function() {
              (i[r].q = i[r].q || []).push(arguments)
          }, i[r].l = 1 * new Date();
      a = s.createElement(o),
          m = s.getElementsByTagName(o)[0];
      a.async = 1;
      a.src = g;
      m.parentNode.insertBefore(a, m)
  })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');

  ga('create', 'UA-67035328-1', 'auto');
  ga('send', 'pageview');


  (function scrollToHash() {
    if (window.location.hash != '') {
      var anchor = $(location.hash).get(0);
      if (anchor) {
        anchor.scrollIntoView();
      }
    }
  })();




  (function mobileNavBuger() {
    var $body = $('body');

    $('.mobile-nav-burger').on('click', function() {
      $body.toggleClass('nav-burger-open');
    });
  })();







  (function rateDocumentation() {
    var $rateDocumentation = $('.rate-documentation');
    var pagePath = 'guide/kuzzle-depth/roles-definitions'.replace(/\//g, '-');
    var categoryRating = parseInt(store('rate-documentation-' + pagePath));

    $rateDocumentation.barrating({
      theme: 'fontawesome-stars',
      initialRatting: 0,
      allowEmpty: true,
      onSelect: function(value, text, event) {
        if (typeof(event) !== 'undefined') {
          // rating was selected by a user
          store('rate-documentation-' + pagePath, event.target.dataset.ratingValue);
          $rateDocumentation.barrating('set', event.target.dataset.ratingValue);
          // $rateDocumentation.barrating('readonly', true); // wired on mobile

          ga('send', 'event', {
            eventCategory: 'documentation-rate',
            eventAction: 'http://docs.kuzzle.io/guide/kuzzle-depth/roles-definitions',
            eventLabel: event.target.dataset.ratingText,
            transport: 'beacon'
          });

          window.setTimeout(function() {
            $('.br-current-rating').css('transition', 'opacity 0.15s');
            $('.br-current-rating').css('opacity', '0');

            window.setTimeout(function() {
              $('.br-current-rating').css('transition', 'opacity 0.9s');
              $('.br-current-rating').text("thank's for feedback !");
              $('.br-current-rating').css('opacity', '1');
            }, 140);
          }, 1);

          window.setTimeout(function() {
            $('.br-current-rating').css('opacity', '0');

            window.setTimeout(function() {
              $('.br-current-rating').css('transition', 'opacity 0.2s');
              if (event.target.dataset.ratingText === 'Excellent documentation') {
                $('.br-current-rating').text(event.target.dataset.ratingText + ' \\o/');
              }
              else {
                $('.br-current-rating').text(event.target.dataset.ratingText);
              }
              $('.br-current-rating').css('opacity', '1');
            }, 1000);
          }, 2500);
        }
        else {
          // rating was selected programmatically
          // by calling `set` method
        }
      }
    });

    $('.br-current-rating').addClass('visible');

    if (!isNaN(categoryRating)) {
      $rateDocumentation.barrating('set', categoryRating);
      $rateDocumentation.barrating('readonly', true);
    }
  })();











  (function leftNavUX() {
    var $wrapper = $('.tocify-wrapper');

    if ($wrapper.length !== 0) {
      var $selectedItem = $('.tocify-level-2.tocify-focus', $wrapper);

      if ($selectedItem.length === 0) {
        $selectedItem = $('.tocify-focus', $wrapper);
      }

      if ($selectedItem.get(0).offsetTop + 120 > $wrapper.height()) {
        $wrapper.scrollTop(Math.ceil($selectedItem.get(0).offsetTop - $wrapper.height() / 2));
      }
    }
  })();









  (function tocUX() {
    var $toc = $('.toc');
    var $content = $('.content');

    //----------------------------
    // fixes toc next to content
    if ($toc.length > 0) {
      var debounceComputeSize = false;
      var computeSize = function() {
        // 280 is the width of left nav / 15 is the margin with content
        $toc.css('left', $content.get('0').offsetLeft + $content.get('0').offsetWidth + 280 + 15 +'px');
        // 30 is the margin with bottom window
        $toc.css('max-height', window.innerHeight - $toc.get('0').offsetTop - 30  + 'px');
      }

      $(window).on('resize', function() {
        clearTimeout(debounceComputeSize);
        debounceComputeSize = setTimeout(computeSize, 13);
      })
      computeSize();
    }
    //----------------------------

    //---------------------------------------------------------------------
    // toogle 'active' class on toc link when headings pass window offset
    if ($toc.length > 0) {
      var headings = {};
      var debounceActiveItem = false;
      var computeActiveItem = function() {
        var lastPassedItem;

        for (let key in headings) {
          headings[key].$link.removeClass('active');

          if (headings[key].offset <= window.pageYOffset + 70) {
            lastPassedItem = headings[key];
          }
        }

        if (lastPassedItem) {
          lastPassedItem.$link.addClass('active');
        }
      }

      $('a[href]', $toc).each(function(index, element) {
        var id = element.href.slice(element.href.indexOf('#'));
        var $ref = $(id).parent();

        if ($ref.length > 0) {
          headings[id] = {
            $ref: $ref,
            $link: $(element),
            offset: $ref.get('0').offsetTop
          }
        }
      });

      $(window).on('scroll', function() {
        clearTimeout(debounceActiveItem);
        debounceActiveItem = setTimeout(computeActiveItem, 10);
      })
      computeActiveItem();
    }
    //---------------------------------------------------------------------
  })();

















  //---------------------------------------------------------------------
  // copy code to clipboard button
  (function codeClipboard() {
    $hljs = $('.hljs');

    if ($hljs.length > 0) {
      var debounceClipboard = false;
      var clipboardSnippets;

      function fallbackMessage(action) {
          var actionMsg = '';
          var actionKey = (action === 'cut' ? 'X' : 'C');
          if (/iPhone|iPad/i.test(navigator.userAgent)) {
              actionMsg = 'No support :(';
          } else if (/Mac/i.test(navigator.userAgent)) {
              actionMsg = 'Press âŒ˜-' + actionKey + ' to ' + action;
          } else {
              actionMsg = 'Press Ctrl-' + actionKey + ' to ' + action;
          }
          return actionMsg;
      }

      $hljs.each(function(index, element) {
        $(element).before('<button class="clipboard" title="copy code to clipboard" data-clipboard-snippet><i class="fa fa-clipboard" aria-hidden="true"></i></button>');
      })

      clipboardSnippets = new Clipboard('[data-clipboard-snippet]', {
          target: function(trigger) {
              return trigger.nextElementSibling;
          }
      });

      clipboardSnippets.on('success', function(e) {
          e.clearSelection();
          $(e.trigger).text('Copied!')

          clearTimeout(debounceClipboard);
          debounceClipboard = setTimeout(function() {
            $(e.trigger).html('<i class="fa fa-clipboard" aria-hidden="true"></i>');
          }, 1200);
      });
      clipboardSnippets.on('error', function(e) {
        e.clearSelection();
        $(e.trigger).text(fallbackMessage(e.action));

        clearTimeout(debounceClipboard);
        debounceClipboard = setTimeout(function() {
          $(e.trigger).html('<i class="fa fa-clipboard" aria-hidden="true"></i>');
        }, 2400);
      });
    }
  })();
  //---------------------------------------------------------------------








  //---------------------------------------------------------------------
  // language tab selector
  (function languageTabSelector() {
    var $languageTabSelector = $('.language-tab-selector a');
    var pageCategory = 'guide'.replace(/\//g, '-');
    var selectedLanguage = store('selected-language' + pageCategory);

    if (selectedLanguage) {
      if ($('.language-tab[data-language="' + selectedLanguage + '"]').length > 0) {
        $('.language-tab-active').removeClass('language-tab-active');
        $('.language-tab-selector a[data-language-name="' + selectedLanguage + '"]').addClass('language-tab-active');
        $('.language-tab[data-language="' + selectedLanguage + '"]').addClass('language-tab-active');
      }
    }

    if ($languageTabSelector.length > 0) {
      $languageTabSelector.on('click touch', function(e) {
        e.preventDefault();
        e.stopPropagation();

        var language = $(this).data('languageName');

        $('.language-tab-active').removeClass('language-tab-active');
        $('.language-tab-selector a[data-language-name="' + language + '"]').addClass('language-tab-active');
        $('.language-tab[data-language="' + language + '"]').addClass('language-tab-active');

        store('selected-language' + pageCategory, language)
      });
    }
  })();
  //---------------------------------------------------------------------









  (function instantSearchUI() {
    var KEY_UP = 38;
    var KEY_DOWN = 40;
    var client = algoliasearch("4RFBRWISJR", "6febf1ebe906bd82bce58d5a20ac6c1b");
    var index = client.initIndex('kuzzle-documentation');
    var template = $('#search-results-template').html();
    var $searchInput = $('.search input[type=search]');
    var $searchResults = $('.search-results');
    var $searchResultsContainer = $('ul', $searchResults);
    var watchResultsDebounce = false;
    var selectedIndex = -1;
    var watchClose = false;
    var lastHits = 0;
    var _a = true;

    var Base64={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(e){var t="";var n,r,i,s,o,u,a;var f=0;e=Base64._utf8_encode(e);while(f<e.length){n=e.charCodeAt(f++);r=e.charCodeAt(f++);i=e.charCodeAt(f++);s=n>>2;o=(n&3)<<4|r>>4;u=(r&15)<<2|i>>6;a=i&63;if(isNaN(r)){u=a=64}else if(isNaN(i)){a=64}t=t+this._keyStr.charAt(s)+this._keyStr.charAt(o)+this._keyStr.charAt(u)+this._keyStr.charAt(a)}return t},decode:function(e){var t="";var n,r,i;var s,o,u,a;var f=0;e=e.replace(/[^A-Za-z0-9+/=]/g,"");while(f<e.length){s=this._keyStr.indexOf(e.charAt(f++));o=this._keyStr.indexOf(e.charAt(f++));u=this._keyStr.indexOf(e.charAt(f++));a=this._keyStr.indexOf(e.charAt(f++));n=s<<2|o>>4;r=(o&15)<<4|u>>2;i=(u&3)<<6|a;t=t+String.fromCharCode(n);if(u!=64){t=t+String.fromCharCode(r)}if(a!=64){t=t+String.fromCharCode(i)}}t=Base64._utf8_decode(t);return t},_utf8_encode:function(e){e=e.replace(/rn/g,"n");var t="";for(var n=0;n<e.length;n++){var r=e.charCodeAt(n);if(r<128){t+=String.fromCharCode(r)}else if(r>127&&r<2048){t+=String.fromCharCode(r>>6|192);t+=String.fromCharCode(r&63|128)}else{t+=String.fromCharCode(r>>12|224);t+=String.fromCharCode(r>>6&63|128);t+=String.fromCharCode(r&63|128)}}return t},_utf8_decode:function(e){var t="";var n=0;var r=c1=c2=0;while(n<e.length){r=e.charCodeAt(n);if(r<128){t+=String.fromCharCode(r);n++}else if(r>191&&r<224){c2=e.charCodeAt(n+1);t+=String.fromCharCode((r&31)<<6|c2&63);n+=2}else{c2=e.charCodeAt(n+1);c3=e.charCodeAt(n+2);t+=String.fromCharCode((r&15)<<12|(c2&63)<<6|c3&63);n+=3}}return t}}


    // focus search input on content loaded
    $searchInput.focus();


    $(window).on('keydown', function (event) {
      if (watchClose) {
        var $results = $('a', $searchResultsContainer);
        var $focusResult = $('a:hover, a:focus', $searchResultsContainer);

        if ($focusResult.length > 0) {
          $results.each(function(index, element) {

            if ($results[index] === $focusResult.get(0)) {
              selectedIndex = index;
            }
          })
        }

        switch (event.keyCode) {
          case KEY_UP:
            event.stopPropagation();
            if (selectedIndex === 0) {
              selectedIndex = -1;
            }

            if (selectedIndex === -1) {
              $searchInput.focus();
              selectedIndex = $results.length - 1;
            }
            else {
              selectedIndex -= 1;
              $results.get(selectedIndex).focus();
            }
            //$('li:not(:last-child).selected').removeClass('selected').next().addClass('selected');

            return false;
          case KEY_DOWN:
            event.stopPropagation();
            if (selectedIndex >= $results.length -1) {
              $searchInput.focus();
              selectedIndex = -1;
            }
            else {
              selectedIndex += 1;
              $results.get(selectedIndex).focus();
            }
            //$('li:not(:first-child).selected').removeClass('selected').prev().addClass('selected');
            return false;
        }
      }
    });

    // search results open/close handlers
    $(window).on('click touch', function() {
      if (watchClose) {
        $searchResults.removeClass('display');
        watchClose = false;

        if (watchResultsDebounce) {
          window.clearTimeout(watchResultsDebounce);
        }
      }
    });

    $searchInput.on('click touch', function(event) {
      if (lastHits > 0) {
        $searchResults.addClass('display');
        watchClose = true;
      }
      event.stopPropagation();
    });

    $searchInput.on('focus', function(event) {
      if (lastHits > 0) {
        $searchResults.addClass('display');
        watchClose = true;
      }

      selectedIndex = -1;
    });

    $searchInput.on('blur', function(event) {
      if (lastHits > 0) {
        $searchResults.addClass('display');
        watchClose = true;
      }
    });
    // end - search results open/close handlers


    // main input listener
    $searchInput.on('input', function(event) {
      var $input = $(this);
      var searchResultsContent = '';
      // var length = (this.value.length + 1) * 6;

      selectedIndex = -1;

      // // resize input length to fit value
      // length = (length > 450) ? 450 : length;
      // this.style.width = (length > 220) ? length + 'px' : '220px';


      // clear search result on empty input
      if (this.value === '' || Base64.encode(this.value) === 'SGVscCBSeXUgYnkgY2xpY2tpbmcgeW91ciB3YXkgdGhyb3VnaCBkZXN0aW55IQ==') {
        $searchResults.removeClass('display');
        $searchResultsContainer.empty();
        watchClose = false;

        return;
      }

      if (_a) {
        console.warn(Base64.decode('WW91IG1pZ2h0IHdhbnQgdG8gYXNrIFJ5dSBmb3IgaGVscA=='));
        _a = false;
      }

      if (Base64.encode(this.value.toLowerCase()) === 'cnl1IGhlbHAgbWU=') {
        var d = document

        s = d.createElement('script');
        s.src = '/' + Base64.decode('YXNzZXRzL2phdmFzY3JpcHQvbGliL2pxdWVyeS5zb21ldGhpbmcuanM=');
        s.async = 'async';
        (d.head || d.body).appendChild(s);

        $searchResultsContainer.empty();
        $searchResults.removeClass('display');
        watchClose = false;

        this.disabled = true;
        this.value = Base64.decode('SGVscCBSeXUgYnkgY2xpY2tpbmcgeW91ciB3YXkgdGhyb3VnaCBkZXN0aW55IQ==');

        return;
      }

      index.search(this.value, function(err, res) {
        if (err) {
          console.error(err);
          return;
        }

        lastHits = res.hits.length;
        if (watchResultsDebounce) {
          window.clearTimeout(watchResultsDebounce);
        }

        if (lastHits === 0) {
          $searchResultsContainer.empty();
          $searchResults.removeClass('display');
          return;
        }

        // send ga event when user has search results but does nothing
        watchResultsDebounce = window.setTimeout(function() {
          ga('send', 'event', {
            eventCategory: 'documentation-search',
            eventAction: (lastHits > 0) ? '<watch_results>' : '<no_results>',
            eventLabel: $searchInput.val(),
            transport: 'beacon'
          });
        }, 4000);

        $searchResults.addClass('display');
        watchClose = true;

        // make search result item from
        for (var key in res.hits) {
          var content = template;

          // here we secure manualy all xml tags wich may can be retrieved by results, but we keep <em> tags for highlighting
          var elements = res.hits[key]._snippetResult.content.value.split('<em>');
          var preview = '';

          for (var k in elements) {
            elements[k] = elements[k].replace(/</g, '&lt;');
            elements[k] = elements[k].replace(/>/g, '&gt;');
          }

          // restore <em></em> tags
          preview = elements.join('<em>');
          preview = preview.replace(/&lt;\/em&gt;/g, '</em>');

          // replace variables in template
          content = content.replace(/__tabindex__/g, key + 2);
          content = content.replace(/__link__/g, 'http://docs.kuzzle.io/' + res.hits[key].path);
          content = content.replace(/__parent__/g, res.hits[key].parent || '');
          content = content.replace(/__firstMember__/g, res.hits[key].firstMember || '');
          content = content.replace(/__title__/g, res.hits[key]._highlightResult.title.value);
          content = content.replace(/__preview__/g, preview);

          searchResultsContent += content;
        }

        // add algolia copyright
        searchResultsContent += '<li style="text-align: right"><img src="https://www.algolia.com/assets/pricing_new/algolia-powered-by-ac7dba62d03d1e28b0838c5634eb42a9.svg" style="margin: 8px 8px 0 0;"></li>';

        // magic jQuery
        $searchResultsContainer.html(searchResultsContent);

        // send ga event on search result hit
        $('a', $searchResultsContainer).on('click touch', function(event) {
          ga('send', 'event', {
            eventCategory: 'documentation-search',
            eventAction: this.href,
            eventLabel: $searchInput.val(),
            transport: 'beacon'
          });
        });
      });
    });

  })();</script></body></html>