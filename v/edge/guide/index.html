<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="google-site-verification" content="luspUdq52gkUU0FFChQ2xmeXSs5HDafpARQ7fVXVBp4" />
    <title>Kuzzle Guide</title>

    <link rel="apple-touch-icon-precomposed" sizes="57x57" href="images/favicon/apple-touch-icon-57x57.png" />
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="images/favicon/apple-touch-icon-114x114.png" />
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="images/favicon/apple-touch-icon-72x72.png" />
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="images/favicon/apple-touch-icon-144x144.png" />
    <link rel="apple-touch-icon-precomposed" sizes="60x60" href="images/favicon/apple-touch-icon-60x60.png" />
    <link rel="apple-touch-icon-precomposed" sizes="120x120" href="images/favicon/apple-touch-icon-120x120.png" />
    <link rel="apple-touch-icon-precomposed" sizes="76x76" href="images/favicon/apple-touch-icon-76x76.png" />
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="images/favicon/apple-touch-icon-152x152.png" />
    <link rel="icon" type="image/png" href="images/favicon/favicon-196x196.png" sizes="196x196" />
    <link rel="icon" type="image/png" href="images/favicon/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/png" href="images/favicon/favicon-32x32.png" sizes="32x32" />
    <link rel="icon" type="image/png" href="images/favicon/favicon-16x16.png" sizes="16x16" />
    <link rel="icon" type="image/png" href="images/favicon/favicon-128.png" sizes="128x128" />
    <meta name="msapplication-TileColor" content="#FFFFFF" />
    <meta name="msapplication-TileImage" content="images/favicon/mstile-144x144.png" />
    <meta name="msapplication-square70x70logo" content="images/favicon/mstile-70x70.png" />
    <meta name="msapplication-square150x150logo" content="images/favicon/mstile-150x150.png" />
    <meta name="msapplication-wide310x150logo" content="images/favicon/mstile-310x150.png" />
    <meta name="msapplication-square310x310logo" content="images/favicon/mstile-310x310.png" />

    <link href="stylesheets/screen.css" rel="stylesheet" type="text/css" media="screen" />
    <link href="stylesheets/print.css" rel="stylesheet" type="text/css" media="print" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
      <script src="javascripts/all.js" type="text/javascript"></script>

  </head>

  <body class="index">
    <header>
      <div class="wrapper">
        <div id="logo">
            <a href="http://kuzzle.io/">&nbsp;</a>
        </div>

        <nav>
          <ul>
            <li>
              <a href="http://kuzzle.io/" class="nav-item">Home</a>
            </li>
            <li>
              <a href="http://docs.kuzzle.io/" class="nav-item developers active">Documentation</a>
            </li>
            <li>
              <a href="http://kuzzle.io/demos-tutorials/" class="nav-item ">Demos</a>
            </li>
            <li>
              <a href="http://kuzzle.io/blog/" class="nav-item ">Blog</a>
            </li>
            <li>
              <a href="https://github.com/kuzzleio/kuzzle" target="_blank" class="nav-item github">
                <i class="icon icon-github icon-small"></i>
              </a>
            </li>
          </ul>
        </nav>
      </div>
      <div class="developer-nav open">
        <ul>
            <li class="active"><a href="/guide/"><span>Guide</span></a></li>
            <li><a href="/sdk-reference/"><span>SDK</span></a></li>
            <li><a href="/real-time-filters/"><span>Real-time filters</span></a></li>
            <li><a href="/validation-reference/"><span>Data Validation</span></a></li>
            <li><a href="/api-reference/"><span>API</span></a></li>
            <li><a href="/plugin-reference/"><span>Plugins</span></a></li>
            <li><a href="/elasticsearch-cookbook/"><span>Elasticsearch Cookbook</span></a></li>
        </ul>
        <div class="search">
          <input type="text" class="search" id="input-search" tabindex="1" placeholder="Search in the guide">
        </div>
      </div>
    </header>

    <div class="container">
      <a href="#" id="nav-button">
        <span>
          NAV
          <img src="images/navbar.png" />
        </span>
      </a>
      <div class="tocify-wrapper">
          <ul class="search-results"></ul>

<!--
        <div id="version-selector">
          <label>
            select version:
            <select>
              <option value="/">v1.0.x (current)</option>
              <option value="/v/edge">next</option>
            </select>
          </label>
        </div>
-->

        <div id="toc">
        </div>
          <ul class="toc-footer">
              <li><a href="http://kuzzle.io">Kuzzle official website</a></li>
              <li><a href="http://github.com/kuzzleio/kuzzle">Kuzzle on GitHub</a></li>
              <li><a href="http://github.com/tripit/slate">Documentation Powered by Slate</a></li>
          </ul>
      </div>
      <div class="page-wrapper">
        <div class="dark-box"></div>
        <div class="content">
          <h1 id="introduction">Introduction</h1>

<p>Kuzzle is a ready-to-use, <strong>on-premises backend</strong> that enables you to manage your persistent data and be notified in real-time on whatever happens to it. It also provides you with a flexible and powerful user-management system.</p>

<p>Kuzzle enables you to build modern web applications and complex IoT networks in no time.</p>

<ul>
<li><strong>Persisted data</strong>: store your data and perform advanced searches on it.</li>
<li><strong>Real-time notifications</strong>: subscribe to fine-grained subsets of data.</li>
<li><strong>User Management</strong>: login, logout and security rules are no more a burden.</li>
<li><strong>Extensible</strong>: fit Kuzzle to your needs by leveraging the plugin system.</li>
</ul>

            <h1 id="getting-started">Getting started</h1>

<p>In this tutorial you will learn in a few steps how to <strong>launch</strong> Kuzzle and how to interact with it by <strong>persisting data</strong> and <strong>being notified</strong> when data is updated.</p>

<h2 id="running-kuzzle">Running Kuzzle</h2>

<p>Before launching Kuzzle, ensure that your system matches the following pre-requisites:</p>

<ul>
<li><strong>Docker v1.10+</strong>, see <a href="https://docs.docker.com/engine/installation/">instructions here</a></li>
<li><strong>Docker-compose v1.8+</strong>, see <a href="https://docs.docker.com/compose/install/">intructions here</a></li>
</ul>

<aside class="notice">
<b>Docker and Docker-compose are not mandatory</b>. Kuzzle can run outside a Docker container. This tutorial uses Docker as it simplifies a lot the startup process. If you wish to run Kuzzle without Docker, jump to the <a href="#manual-install">manual installation guide</a>.
</aside>

<p>Thanks to Docker-compose, running Kuzzle is easy. Just grab the standard <a href="http://kuzzle.io/docker-compose.yml">docker-compose.yml</a> file, copy it into a directory and start Kuzzle:</p>
<pre class="highlight shell"><code><span class="gp">$ </span>sudo sysctl -w vm.max_map_count<span class="o">=</span>262144
<span class="gp">$ </span>wget http://kuzzle.io/docker-compose.yml
<span class="gp">$ </span>docker-compose up
</code></pre>

<aside class="notice">
The &ldquo;sysctl&rdquo; command is needed by Elasticsearch v5.x. More details <a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.x/vm-max-map-count.html">here</a>.
</aside>

<p>Your terminal will show the log messages of Kuzzle&rsquo;s components starting. After only a few seconds, you should see the following ready message appear:</p>
<pre class="highlight plaintext"><code>kuzzle_1         | [✔] Kuzzle server ready
</code></pre>

<p>Your Kuzzle server is now ready to be used. For instance, you can hit the main HTTP API endpoint by browsing the page <a href="http://localhost:7511?pretty=true">http://localhost:7511?pretty=true</a> or via cURL on the command line:</p>
<pre class="highlight shell"><code><span class="gp">$ </span>curl <span class="s2">"http://localhost:7511/?pretty=true"</span>
</code></pre>

<p>Kuzzle will respond you with a list of the existing routes.</p>

<aside class="success">
Kuzzle is up and running. It will accept requests at the following addresses:
<ul>
  <li><code>localhost:7511</code> via <strong>standard HTTP requests,</strong></li>
  <li><code>localhost:7513</code> via a <strong>Websocket</strong> client (like the <a href="https://github.com/kuzzleio/sdk-javascript">Javascript SDK</a>),</li>
  <li><code>localhost:7512</code> via <strong>Socket.IO</strong> (used as a fallback by the SDK on browsers that do not provide Websocket support).</li>
</ul>
</aside>

<aside class="notice">
Having trouble? <a href="https://gitter.im/kuzzleio/kuzzle">Get in touch with us on Gitter!</a> We&rsquo;ll be happy to help.
</aside>

<h4 id="where-do-we-go-from-here">Where do we go from here?</h4>

<p>Now that Kuzzle is running on your computer, you can dive into playing with it by:</p>

<ul>
<li><a href="#running-kuzzle-backoffice">installing the Backoffice</a>, a handy way to manage data and security in Kuzzle;</li>
<li>installing one of the available <a href="/sdk-reference/">Kuzzle SDK</a> to power-up one of your projects:

<ul>
<li><a href="https://github.com/kuzzleio/sdk-javascript">Javascript</a> (check the <a href="#sdk-play-time">SDK play time</a> section below),</li>
<li><a href="https://github.com/kuzzleio/sdk-php">PHP</a>,</li>
<li><a href="https://github.com/kuzzleio/sdk-ios">iOS</a>,</li>
<li><a href="https://github.com/kuzzleio/sdk-android">Android</a>;</li>
</ul></li>
<li>exploring the <a href="/api-reference/">Kuzzle API reference</a>;</li>
<li><a href="#manual-install">setting-up a Kuzzle Server without Docker</a>.</li>
</ul>

<aside class="notice">
You can also <a href="#installing-kuzzle-manually-on-linux">install Kuzzle manually</a>.
</aside>

<h2 id="sdk-play-time">SDK play time</h2>

<p>It&rsquo;s time to play with the <a href="/sdk-reference">Kuzzle SDK</a>. In this section, we will persist a document and subscribe to notifications in Kuzzle using the JS SDK.</p>

<p>Before proceeding, ensure that your system matches the following requisites:</p>

<ul>
<li>A fairly recent version of <strong>NodeJS</strong> (i.e. v6+) should be installed on your system (<a href="https://nodejs.org/en/download/">instructions here</a>),</li>
<li>A Kuzzle server up and running.</li>
</ul>

<h3 id="create-your-first-quot-hello-world-quot-document">Create your first &ldquo;Hello World&rdquo; document</h3>

<p>Create your playground directory and install the <a href="/sdk-reference">Javascript SDK</a> from the command line using npm:</p>
<pre class="highlight shell"><code><span class="gp">$ </span>mkdir kuzzle-playground
<span class="gp">$ </span><span class="nb">cd </span>kuzzle-playground
<span class="gp">$ </span>npm install kuzzle-sdk
</code></pre>

<p>Save the following JS code in the new <code class="prettyprint">create.js</code> file:</p>
<pre class="highlight javascript"><code><span class="kd">var</span> <span class="nx">Kuzzle</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'kuzzle-sdk'</span><span class="p">)</span>

<span class="c1">// connect to the Kuzzle server</span>
<span class="kd">var</span> <span class="nx">kuzzle</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Kuzzle</span><span class="p">(</span><span class="s1">'localhost'</span><span class="p">,</span> <span class="p">{</span>
    <span class="na">defaultIndex</span><span class="p">:</span> <span class="s1">'playground'</span>
  <span class="p">})</span>

<span class="c1">// get a reference to the a collection</span>
<span class="kd">var</span> <span class="nx">collection</span> <span class="o">=</span> <span class="nx">kuzzle</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">'mycollection'</span><span class="p">)</span>

<span class="c1">// define the document itself</span>
<span class="kd">var</span> <span class="nb">document</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">message</span><span class="p">:</span> <span class="s1">'Hello, world!'</span>
<span class="p">}</span>

<span class="c1">// persist the document into the collection</span>
<span class="nx">collection</span><span class="p">.</span><span class="nx">createDocument</span><span class="p">(</span><span class="nb">document</span><span class="p">)</span>
</code></pre>

<p>Run your file in NodeJS</p>
<pre class="highlight shell"><code><span class="gp">$ </span>node create.js
</code></pre>

<aside class="success">
You have persisted your first document in Kuzzle. If you are running the Backoffice, you can use it to check the existence of the newly created document.
</aside>

<aside class="notice">
Having trouble? <a href="https://gitter.im/kuzzleio/kuzzle-bo">Get in touch with us on Gitter!</a> We&rsquo;ll be happy to help.
</aside>

<p><em>You can find more resources about Kuzzle SDK in the <a href="/sdk-reference">SDK Documentation</a>.</em></p>

<h3 id="subscribe-to-data-changes-pub-sub">Subscribe to data changes (pub/sub)</h3>

<p>Kuzzle provides pub/sub features that allow you to be notified in real-time on the state of your data (check the <a href="/sdk-reference/#room">Room Class Documentation</a> for a deep-dive on notifications).</p>

<p>Let&rsquo;s get started. Open a new termnial in the playground directory you created before and create the <code class="prettyprint">subscribe.js</code> file containing the following code:</p>
<pre class="highlight javascript"><code><span class="kd">var</span> <span class="nx">Kuzzle</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'kuzzle-sdk'</span><span class="p">)</span>

<span class="c1">// connect to the Kuzzle server</span>
<span class="kd">var</span> <span class="nx">kuzzle</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Kuzzle</span><span class="p">(</span><span class="s1">'localhost'</span><span class="p">,</span> <span class="p">{</span>
    <span class="na">defaultIndex</span><span class="p">:</span> <span class="s1">'playground'</span>
  <span class="p">})</span>

<span class="c1">// create a reference to the data collection</span>
<span class="kd">var</span> <span class="nx">collection</span> <span class="o">=</span> <span class="nx">kuzzle</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">'mycollection'</span><span class="p">)</span>

<span class="c1">// define a filter</span>
<span class="kd">var</span> <span class="nx">filter</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">exists</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">field</span><span class="p">:</span> <span class="s1">'message'</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// create a subscription on the collection matching given filters</span>
<span class="nx">collection</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="nx">filter</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// this function is called each time kuzzle notifies us with a document matching our filters</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'message received from kuzzle:'</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span>
<span class="p">})</span>
</code></pre>

<p>Run your file in NodeJS</p>
<pre class="highlight shell"><code><span class="gp">$ </span>node subscribe.js
</code></pre>

<p>And let it wait for documents entering the scope of the filter.</p>

<p>Now, get back to the previous terminal window and execute once more the <code class="prettyprint">create.js</code> script. Take a look at the output of the <code class="prettyprint">subscribe.js</code> script. You will see that, each time a document with a <code class="prettyprint">message</code> field is persisted in Kuzzle, a <a href="#realtime-notifications">notification</a> is shown as standard output.</p>

<aside class="success">
You just leveraged Kuzzle&rsquo;s pub/sub mechanism.
</aside>

<aside class="notice">
Having trouble? <a href="https://gitter.im/kuzzleio/kuzzle-bo">Get in touch with us on Gitter!</a> We&rsquo;ll be happy to help.
</aside>

<h4 id="where-do-we-go-from-here">Where do we go from here?</h4>

<p>Now that you are started and operational with Kuzzle, you can fully leverage its power by:</p>

<ul>
<li><a href="/sdk-reference">taking a look at the SDK reference</a>;</li>
<li><a href="/real-time-filters">mastering the Kuzzle real-time filtering syntax</a> to create incredibly fine-grained and blazing-fast subscriptions;</li>
<li><a href="/guide/#security">learning how to manage users and set-up fine-grained permission rights</a>.</li>
</ul>

            <h1 id="essentials">Essentials</h1>

<h2 id="basic-concepts">Basic concepts</h2>

<h4 id="persistent-data">Persistent data</h4>

<p>Kuzzle relies on <a href="https://www.elastic.co/">Elasticsearch</a> to store and fetch persistent data. You can perform a variety of CRUD and fine-grained search operations on persistent data. Please refer to the <a href="#working-with-persistent-data-in-kuzzle">dedicated section</a> for more details.</p>

<h4 id="real-time-notifications">Real-time notifications</h4>

<p>Kuzzle enables you to set up subscriptions to sets of data, in order to be notified in real-time about whatever happens to them.
You can create a subscription by selecting a set of data. Selections (also called <strong>filters</strong>) are expressed in a Domain-specific Language (DSL) that we tailored for this purpose. Please refer to the <a href="#realtime-notifications-in-kuzzle">dedicated section</a> for more details.</p>

<h4 id="sdk">SDK</h4>

<p>Kuzzle ships with a set of open-source <a href="/sdk-reference">SDK</a> for a variety of languages:</p>

<ul>
<li><a href="https://github.com/kuzzleio/sdk-javascript">Javascript</a> (NodeJS &amp; Browsers)</li>
<li><a href="https://github.com/kuzzleio/sdk-android">Android</a></li>
<li><a href="https://github.com/kuzzleio/sdk-php">PHP</a></li>
<li>C (planned)</li>
</ul>

<h4 id="supported-protocols">Supported protocols</h4>

<p>Kuzzle supports a variety of communication protocols.<br>
For the time being, Kuzzle supports the following protocols:</p>

<ul>
<li>HTTP</li>
<li>Websocket</li>
<li>Socket.io</li>
<li>MQTT (via plugin)</li>
</ul>

<p>You can directly interact with Kuzzle using the <a href="/api-reference">Kuzzle API reference</a>.</p>

<h4 id="authentication">Authentication</h4>

<p>Kuzzle supports a variety of authentication strategies via <a href="http://passportjs.org/">PassportJS</a>. Local and OAuth-based authentication is natively supported, but you can also add your own custom strategy.</p>

<p>Please refer to the <a href="#security">dedicated section</a> for more details.</p>

<h4 id="plugins">Plugins</h4>

<p>Kuzzle is extensible in many ways. Plugins enable you to</p>

<ul>
<li>trigger actions on data-related events,</li>
<li>intercept the data flow at any point of its lifecycle,</li>
<li>add custom methods to the public API,</li>
<li>add new communication protocols,</li>
<li>add new authentication strategies.</li>
</ul>

<p>Please refer to the <a href="#plugins">dedicated section</a> for more details.</p>

            <h2 id="installing-kuzzle">Installing Kuzzle</h2>

<h3 id="docker">Docker</h3>

<p>Before launching Kuzzle, ensure that your system matches the following pre-requisites:</p>

<ul>
<li><strong>Docker v1.10+</strong>, see <a href="https://docs.docker.com/engine/installation/">instructions here</a></li>
<li><strong>Docker-compose v1.8+</strong>, see <a href="https://docs.docker.com/compose/install/">instructions here</a></li>
</ul>

<p>Get the standard <a href="http://kuzzle.io/docker-compose.yml">docker-compose.yml</a> file, copy it into a directory and start Kuzzle:</p>

<p>In this case, you need to increase the maximum virtual memory allowed by typing</p>
<pre class="highlight shell"><code><span class="gp">$ </span>sudo sysctl -w vm.max_map_count<span class="o">=</span>262144
<span class="gp">$ </span>wget http://kuzzle.io/docker-compose.yml
<span class="gp">$ </span>docker-compose up
</code></pre>

<p>To persist this changes add this line to your /etc/sysctl.conf
<code class="prettyprint">
m.max_map_count=262144
</code></p>

<aside class="notice">
The &ldquo;sysctl&rdquo; command is needed by Elasticsearch v5.x. More details <a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.x/vm-max-map-count.html">here</a>.
</aside>

<p>Your terminal will show the log messages of Kuzzle&rsquo;s components starting. After only a few seconds, you should see the following ready message appear:</p>
<pre class="highlight plaintext"><code>kuzzle_1         | [✔] Kuzzle server ready
</code></pre>

<p>Your Kuzzle server is now ready to be used. For instance, you can hit the main HTTP API endpoint by browsing the page <a href="http://localhost:7511">http://localhost:7511</a> or via cURL on the command line:</p>
<pre class="highlight shell"><code><span class="gp">$ </span>curl <span class="s2">"http://localhost:7511/?pretty"</span>
</code></pre>

<p>Kuzzle will respond you with a list of the existing routes.</p>

<p>Docker-compose will get the missing images for you on the first run, but it will not keep them up to date. To fetch the latest versions of all the images that compose the Kuzzle stack, you can use the following command:</p>
<pre class="highlight shell"><code><span class="gp">$ </span>docker-compose -f &lt;docker-compose-file.yml&gt; pull
</code></pre>

<h3 id="manually-on-linux">Manually (on Linux)</h3>

<p>In this section we will cover the manual installation on Linux systems, since this is the environment all the components of the Kuzzle stack work natively in.</p>

<aside class="notice">
By default, Kuzzle expects all the components to be running on localhost. You can use the <a href="#configuring-kuzzle">configuration parameters</a> to change this behavior.
</aside>

<p>We will run the Kuzzle stack using <a href="http://pm2.keymetrics.io/">pm2</a>, from the current user home directory.</p>

<h4 id="prerequisites">Prerequisites</h4>

<ul>
<li>A <a href="https://www.elastic.co/products/elasticsearch">Elasticsearch</a> v5.x instance running on localhost:9200 (<em>preferred version: v5.0, but v2.x is also supported</em>).</li>
<li>A <a href="http://redis.io/">Redis</a> v3.x instance running on localhost:6379 (<em>preferred version: v3.2</em>).</li>
<li><a href="https://nodejs.org/en/download/package-manager/">NodeJS</a> v6.x or upper.</li>
<li><code class="prettyprint">gcc</code> and <code class="prettyprint">python</code>. On Debian-based systems: <code class="prettyprint">sudo apt-get install build-essential python</code>.</li>
</ul>

<h4 id="step-1-retrieve-kuzzle-components-source-code">Step 1 - Retrieve Kuzzle components source code</h4>

<ol>
<li>Create the Kuzzle root directory:</li>
</ol>
<pre class="highlight shell"><code><span class="gp">$ </span>mkdir -p ~/kuzzle
<span class="gp">$ </span><span class="nb">cd</span> ~/kuzzle
</code></pre>

<ol>
<li>Create a directory for Kuzzle Proxy and install it:</li>
</ol>
<pre class="highlight shell"><code><span class="gp">$ </span><span class="nb">cd</span> ~/kuzzle
<span class="gp">$ </span>git clone https://github.com/kuzzleio/kuzzle-proxy.git
<span class="gp">$ </span><span class="nb">cd </span>kuzzle-proxy
<span class="gp">$ </span>npm install
</code></pre>

<ol>
<li>Create a directory for Kuzzle Core and install it:</li>
</ol>
<pre class="highlight shell"><code><span class="gp">$ </span><span class="nb">cd</span> ~/kuzzle
<span class="gp">$ </span>git clone https://github.com/kuzzleio/kuzzle.git
<span class="gp">$ </span><span class="nb">cd </span>kuzzle
<span class="gp">$ </span>npm install
</code></pre>

<ol>
<li>Create a directory for Kuzzle Back Office and <a href="#running-kuzzle-backoffice">install it</a>.</li>
</ol>

<h4 id="step-2-pm2">Step 2 - pm2</h4>

<ol>
<li>Install pm2:</li>
</ol>
<pre class="highlight shell"><code><span class="gp">$ </span>sudo npm install -g pm2
</code></pre>

<ol>
<li>Create a <a href="http://pm2.keymetrics.io/docs/usage/application-declaration/#process-file">pm2 configuration file</a>:</li>
</ol>
<pre class="highlight shell"><code><span class="gp">$ </span><span class="nb">echo</span> <span class="s2">"apps:
   - name: kuzzle-proxy
     cwd: </span><span class="k">${</span><span class="nv">KUZZLE_PROXY_INSTALL_DIR</span><span class="k">}</span><span class="s2">
     script: </span><span class="k">${</span><span class="nv">KUZZLE_PROXY_INSTALL_DIR</span><span class="k">}</span><span class="s2">/index.js
   - name: kuzzle
     cwd: </span><span class="k">${</span><span class="nv">KUZZLE_CORE_INSTALL_DIR</span><span class="k">}</span><span class="s2">
     script: </span><span class="k">${</span><span class="nv">KUZZLE_CORE_INSTALL_DIR</span><span class="k">}</span><span class="s2">/bin/kuzzle
     args: start
     env:
       kuzzle_server__http__port: 7510
       kuzzle_services__proxyBroker__host: localhost
  "</span> &gt; ~/kuzzle/pm2.conf.yml
</code></pre>

<ol>
<li>Run Kuzzle via pm2 and show the logs:</li>
</ol>
<pre class="highlight shell"><code><span class="gp">$ </span>pm2 start ~/kuzzle/pm2.conf.yml
<span class="gp">$ </span>pm2 logs
</code></pre>

<p>After only a few seconds, you will see the following ready message appear:</p>
<pre class="highlight plaintext"><code>kuzzle_1         | [✔] Kuzzle server ready
</code></pre>

<p>The Kuzzle Back-office can be reached on http://localhost:3000.<br>
Kuzzle HTTP API can be reached on http://localhost:7511/<br>
Socket IO and Websocket channels can respectively be reached on ports 7512 and 7513.</p>

<h5 id="change-external-services-hosts-or-ports">Change external services hosts or ports</h5>

<p>If you are running some of the service(s) externally, you can configure their host and port using some environment variables and/or a <code class="prettyprint">.kuzzlerc</code> file.</p>

<p>Please refer to <a href="#configuration">Kuzzle configuration section</a> for more information.</p>

<h2 id="running-kuzzle-backoffice">Running Kuzzle Backoffice</h2>

<p>The Kuzzle Backoffice is a handy <strong>web application</strong> that helps you administrate Kuzzle. You can use it to <strong>manage your data</strong>, subscribe to <strong>realtime notifications</strong> and manage <strong>security</strong> rules.</p>

<p>You can use the <a href="http://kuzzle-backoffice.netlify.com/">publicly hosted Kuzzle Backoffice</a>.
If you want to host the Kuzzle Backoffice on your own server, you can download the source code <a href="https://github.com/kuzzleio/kuzzle-backoffice/releases">here</a>.</p>

<p>In both cases, you&rsquo;ll be able to <a href="#select-the-kuzzle-instance-to-connect-to">select the Kuzzle server</a> you want to manage once the Backoffice starts up.</p>

<aside class="notice">
Having trouble? <a href="https://gitter.im/kuzzleio/kuzzle-bo">Get in touch with us on Gitter!</a>
</aside>

<h3 id="select-the-kuzzle-server-to-connect-to">Select the Kuzzle server to connect to</h3>

<p>The Kuzzle Backoffice automatically looks for a Kuzzle server on <code class="prettyprint">localhost:7513</code>. If none is present, you will be prompted to choose a Kuzzle instance to connect to.</p>

<p>You can tell the Backoffice to connect to any Kuzzle server by clicking on the <strong>&ldquo;Choose Environment&rdquo;</strong> dropdown menu, then by selecting <strong>&ldquo;Create new&rdquo;</strong>.</p>

<p><img alt="Kuzzle Backoffice is trying to connect to a Kuzzle server" src="images/kuzbo-connecting.png" /></p>

<p>Create a new Backoffice environment by providing the address of the Kuzzle server you want to administrate. You can associate it with a custom <strong>name</strong> (e.g. &ldquo;Development&rdquo; or &ldquo;My First Kuzzle&rdquo;) and a <strong>color</strong> (e.g. red may be a good idea for production environments).</p>

<aside class="success">Your Kuzzle Backoffice is connected to Kuzzle.</aside>

<aside class="notice">
Having trouble? <a href="https://gitter.im/kuzzleio/kuzzle-bo">Get in touch with us on Gitter!</a> We&rsquo;ll be happy to help.
</aside>

<h3 id="create-an-admin-account">Create an admin account</h3>

<p>At this point, Kuzzle is still pristine, which means that no admin account has been set-up: this means that the <code class="prettyprint">anonymous</code> user has full rights on the server.</p>

<p><img alt="Kuzzle Backoffice prompts the creation of a first admin account" src="images/kuzbo-firstadmin.png" /></p>

<p>The Backoffice will prompt you with an admin account name and a password. <strong>Leave the &ldquo;Reset anonymous account rights&rdquo; unchecked</strong>, as we will use the <code class="prettyprint">anonymous</code> account in the next steps of this tutorial.</p>

<p>Once you created the admin account, use its credentials to log-in.</p>

<aside class="success">You are now able to manage Kuzzle via the Backoffice.</aside>

<aside class="notice">
Having trouble? <a href="https://gitter.im/kuzzleio/kuzzle-bo">Get in touch with us on Gitter!</a> We&rsquo;ll be happy to help.
</aside>

            <h2 id="configuring-kuzzle">Configuring Kuzzle</h2>

<p>The <strong>complete default configuration</strong> of Kuzzle is stored in the <a href="https://github.com/kuzzleio/kuzzle/blob/master/.kuzzlerc.sample">kuzzlerc file</a> at the root of the installation directory.</p>

<p>Kuzzle uses <a href="https://github.com/dominictarr/rc">rc</a> to <strong>override</strong> its default configuration. The most common ways to do it is:</p>

<ul>
<li>via a <code class="prettyprint">.kuzzlerc</code> file (<a href="https://github.com/kuzzleio/kuzzle/blob/master/.kuzzlerc.sample">example here</a>);</li>
<li>via environment variables prefixed with <code class="prettyprint">kuzzle_</code>.</li>
</ul>

<h4 id="example-1-configuring-kuzzle-via-a-custom-kuzzlerc-file">Example 1: configuring Kuzzle via a custom <code class="prettyprint">.kuzzlerc</code> file</h4>

<p>You can write your custom config in <code class="prettyprint">$HOME/.kuzzlerc</code> or <a href="https://github.com/dominictarr/rc/blob/master/README.md#standards">any other valid location</a>:</p>
<pre class="highlight json"><code><span class="p">{</span><span class="w">
  </span><span class="nt">"services"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nt">"db"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nt">"host"</span><span class="p">:</span><span class="w"> </span><span class="s2">"&lt;ES_HOST&gt;"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"port"</span><span class="p">:</span><span class="w"> </span><span class="err">&lt;ES_PORT&gt;</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nt">"proxyBroker"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nt">"host"</span><span class="p">:</span><span class="w"> </span><span class="s2">"&lt;PROXY_HOST&gt;"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>

<h4 id="example-2-configuring-kuzzle-via-environment-variables">Example 2: configuring Kuzzle via Environment Variables</h4>

<p>The name of the environment variables must mimic the structure of the configuration object to override:</p>

<ul>
<li>the variable needs to be prefixed with <code class="prettyprint">kuzzle_</code>,</li>
<li>the <code class="prettyprint">__</code> correspond to the levels of nesting in the configuration object (e.g. <code class="prettyprint">kuzzle_services__proxyBroker__host</code> corresponds to <code class="prettyprint">services.proxyBroker.host</code>).</li>
</ul>
<pre class="highlight shell"><code><span class="gp">$ </span><span class="nv">kuzzle_services__proxyBroker__host</span><span class="o">=</span>&lt;PROXY_HOST&gt; node bin/kuzzle start
</code></pre>

<p>Environment variables are particularly handy to set your custom configuration <strong>through a Docker container</strong>. It is very easy to pass environment variables via the <code class="prettyprint">environment</code> section of a <code class="prettyprint">docker-compose.yml</code> file. Take a look at how we pass environment variables to Kuzzle in our default docker-compose file:</p>
<pre class="highlight yaml"><code><span class="s">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">2'</span>

<span class="s">services</span><span class="pi">:</span>
  <span class="s">proxy</span><span class="pi">:</span>
    <span class="s">image</span><span class="pi">:</span> <span class="s">kuzzleio/proxy</span>
    <span class="s">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">7511-7513:7511-7513"</span>

  <span class="s">kuzzle</span><span class="pi">:</span>
    <span class="s">image</span><span class="pi">:</span> <span class="s">kuzzleio/kuzzle</span>
    <span class="s">depends_on</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">proxy</span>
      <span class="pi">-</span> <span class="s">redis</span>
      <span class="pi">-</span> <span class="s">elasticsearch</span>
    <span class="s">environment</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">kuzzle_services__db__host=elasticsearch</span>
      <span class="pi">-</span> <span class="s">kuzzle_services__internalCache__node__host=redis</span>
      <span class="pi">-</span> <span class="s">kuzzle_services__memoryStorage__node__host=redis</span>
      <span class="pi">-</span> <span class="s">kuzzle_services__proxyBroker__host=proxy</span>
      <span class="pi">-</span> <span class="s">NODE_ENV=production</span>

  <span class="s">redis</span><span class="pi">:</span>
    <span class="s">image</span><span class="pi">:</span> <span class="s">redis:3.2</span>

  <span class="s">elasticsearch</span><span class="pi">:</span>
    <span class="s">image</span><span class="pi">:</span> <span class="s">elasticsearch:5.0</span>
</code></pre>

<aside class="notice">
  For an exhaustive list of configuration parameters, please refer to the <a href="https://github.com/kuzzleio/kuzzle/blob/master/.kuzzlerc.sample">kuzzlerc</a> file.
</aside>

            <h2 id="working-with-persistent-data">Working with persistent data</h2>

<p>Kuzzle relies on <a href="https://www.elastic.co/">Elasticsearch</a> to store and fetch persistent data.</p>

<p>In Kuzzle, data is organized in the following way:</p>

<ul>
<li><strong>Documents</strong> are the atomic unit of data. They are defined as JSON structures, in the classical NoSQL fashion and are identified by a unique <code class="prettyprint">_id</code>.</li>
<li>Documents are grouped into <strong>Collections</strong>, identified by a unique name.</li>
<li>Collections are grouped into <strong>Indexes</strong>, identified by a unique name.</li>
</ul>

<h3 id="document-crud">Document CRUD</h3>

<p>Kuzzle ships with a full data <a href="https://en.wikipedia.org/wiki/Create,_read,_update_and_delete">CRUD</a> API that enables you to operate in many ways on your documents.</p>

<p>Let&rsquo;s <a href="/api-reference/#create48"><strong>create a new document</strong></a>, for example, in <code class="prettyprint">mycollection</code>, within <code class="prettyprint">myindex</code> via the HTTP protocol. This is done by sending a <code class="prettyprint">POST</code> request to the API endpoint <code class="prettyprint">http://localhost:7511/myindex/mycollection/_create</code> with the body set to</p>
<pre class="highlight json"><code><span class="p">{</span><span class="w">
  </span><span class="nt">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Hello, world!"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>

<p>Notice that the document is associated to the auto-generated id <code class="prettyprint">AVkDBl3YsT6qHI7MxLz0</code>, as we can see in the response:</p>
<pre class="highlight json"><code><span class="p">{</span><span class="w">
  </span><span class="nt">"status"</span><span class="p">:</span><span class="w"> </span><span class="mi">200</span><span class="p">,</span><span class="w">
  </span><span class="nt">"error"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
  </span><span class="nt">"requestId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"38d08fa9-449d-47f7-8593-dc136f8b3559"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"controller"</span><span class="p">:</span><span class="w"> </span><span class="s2">"document"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"action"</span><span class="p">:</span><span class="w"> </span><span class="s2">"create"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"collection"</span><span class="p">:</span><span class="w"> </span><span class="s2">"mycollection"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"index"</span><span class="p">:</span><span class="w"> </span><span class="s2">"myindex"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"metadata"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
  </span><span class="nt">"headers"</span><span class="p">:</span><span class="w"> </span><span class="p">{},</span><span class="w">
  </span><span class="nt">"result"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nt">"_index"</span><span class="p">:</span><span class="w"> </span><span class="s2">"myindex"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"mycollection"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"AVkDBl3YsT6qHI7MxLz0"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"_version"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
    </span><span class="nt">"result"</span><span class="p">:</span><span class="w"> </span><span class="s2">"created"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"_shards"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nt">"total"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
      </span><span class="nt">"successful"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
      </span><span class="nt">"failed"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nt">"created"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
    </span><span class="nt">"_source"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nt">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Hello, world!"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"_kuzzle_info"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nt">"author"</span><span class="p">:</span><span class="w"> </span><span class="s2">"-1"</span><span class="p">,</span><span class="w">
        </span><span class="nt">"createdAt"</span><span class="p">:</span><span class="w"> </span><span class="mi">1481814465050</span><span class="p">,</span><span class="w">
        </span><span class="nt">"updatedAt"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
        </span><span class="nt">"updater"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
        </span><span class="nt">"active"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
        </span><span class="nt">"deletedAt"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>

<p>Take some time to examine the content of a <a href="#kuzzle-response-objects">Kuzzle Response</a>. You may notice that it contains useful information like the name of the <a href="/#core-architecture">controller and action</a> that correspond to the HTTP route we hit with our request, or the complete KuzzleDocument object we just created.</p>

<p>One more thing you may notice is that <code class="prettyprint">myindex</code> and <code class="prettyprint">mycollection</code> are created on-the-fly along with the document. Let&rsquo;s verify it by <a href="/api-reference/?http#list"><strong>getting the list of collections</strong></a> stored in <code class="prettyprint">myindex</code> by sending a <code class="prettyprint">GET</code> request to <code class="prettyprint">http://localhost:7511/myindex/_list</code>.</p>
<pre class="highlight json"><code><span class="p">{</span><span class="w">
  </span><span class="nt">"status"</span><span class="p">:</span><span class="w"> </span><span class="mi">200</span><span class="p">,</span><span class="w">
  </span><span class="nt">"error"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
  </span><span class="nt">"requestId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"51b276c3-3698-4412-b3dc-80d0f84541fb"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"controller"</span><span class="p">:</span><span class="w"> </span><span class="s2">"collection"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"action"</span><span class="p">:</span><span class="w"> </span><span class="s2">"list"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"collection"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
  </span><span class="nt">"index"</span><span class="p">:</span><span class="w"> </span><span class="s2">"myindex"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"metadata"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
  </span><span class="nt">"headers"</span><span class="p">:</span><span class="w"> </span><span class="p">{},</span><span class="w">
  </span><span class="nt">"result"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nt">"collections"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
      </span><span class="p">{</span><span class="w">
        </span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"mycollection"</span><span class="p">,</span><span class="w">
        </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"stored"</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">],</span><span class="w">
    </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"all"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>

<p>Take a look at the <code class="prettyprint">result</code> field in the Response from Kuzzle. It contains an array of <code class="prettyprint">collections</code>, each one defined by a <code class="prettyprint">name</code> and a <code class="prettyprint">type</code>. <code class="prettyprint">mycollection</code> is of type <code class="prettyprint">stored</code> (which stands for persistent). This is made to distinguish persisted collection from the <code class="prettyprint">realtime</code> (or volatile) collections, used to identify <a href="#realtime-notifications">real-time documents</a>.</p>

<p>Let&rsquo;s <a href="/api-reference/?http#update"><strong>modify to our brand new document</strong></a> by sending a <code class="prettyprint">PUT</code> request to <code class="prettyprint">http://localhost:7511/myindex/mycollection/AVkDBl3YsT6qHI7MxLz0/_update</code> with the body set to:</p>
<pre class="highlight json"><code><span class="p">{</span><span class="w">
  </span><span class="nt">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"in a bottle"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"an_englishman"</span><span class="p">:</span><span class="w"> </span><span class="s2">"in New York"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>

<p>Which gives us the response&hellip;</p>
<pre class="highlight json"><code><span class="p">{</span><span class="w">
  </span><span class="nt">"status"</span><span class="p">:</span><span class="w"> </span><span class="mi">200</span><span class="p">,</span><span class="w">
  </span><span class="nt">"error"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
  </span><span class="nt">"requestId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"6241ec4d-8529-43ba-9b77-3028b99cd621"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"controller"</span><span class="p">:</span><span class="w"> </span><span class="s2">"document"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"action"</span><span class="p">:</span><span class="w"> </span><span class="s2">"update"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"collection"</span><span class="p">:</span><span class="w"> </span><span class="s2">"mycollection"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"index"</span><span class="p">:</span><span class="w"> </span><span class="s2">"myindex"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"metadata"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
  </span><span class="nt">"headers"</span><span class="p">:</span><span class="w"> </span><span class="p">{},</span><span class="w">
  </span><span class="nt">"result"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nt">"_index"</span><span class="p">:</span><span class="w"> </span><span class="s2">"myindex"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"mycollection"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"AVkDBl3YsT6qHI7MxLz0"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"_version"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
    </span><span class="nt">"result"</span><span class="p">:</span><span class="w"> </span><span class="s2">"updated"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"_shards"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nt">"total"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
      </span><span class="nt">"successful"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
      </span><span class="nt">"failed"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>

<p>&hellip;telling us that the document has been successfully updated.</p>

<p>Now, we&rsquo;ll let you figure out what happens when we send a <code class="prettyprint">DELETE</code> request to <code class="prettyprint">http://localhost:7511/myindex/mycollection/AVkDBl3YsT6qHI7MxLz0</code> with an empty body (take a look at the <a href="/api-reference/?http#delete">API Reference</a> if you don&rsquo;t want to try).</p>

<h3 id="document-search">Document Search</h3>

<p>One thing that Elasticsearch is <em>really</em> good at doing is&hellip; Searching! It enables to create extremely precise search queries, thanks to its powerful query DSL. We wrote a <a href="#elasticsearch-cookbook">comprehensive cookbook</a> to help you understand how it works in detail, but let&rsquo;s take a look at a couple of simple examples, just to get started.</p>

<p>Say we want to <a href="/api-reference/?http#search"><strong>find</strong></a> all the documents within <code class="prettyprint">mycollection</code>, via the HTTP protocol. To do it, we send a <code class="prettyprint">POST</code> request to <code class="prettyprint">http://localhost:7511/myindex/mycollection/_search</code> (we leave the body empty since we have no filters to apply to our query). Depending on the documents you have created in your database, the response will look like:</p>
<pre class="highlight json"><code><span class="p">{</span><span class="w">
  </span><span class="nt">"status"</span><span class="p">:</span><span class="w"> </span><span class="mi">200</span><span class="p">,</span><span class="w">
  </span><span class="nt">"error"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
  </span><span class="nt">"requestId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"3b486d49-f1f9-4595-8c10-b63cc5fc1279"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"controller"</span><span class="p">:</span><span class="w"> </span><span class="s2">"document"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"action"</span><span class="p">:</span><span class="w"> </span><span class="s2">"search"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"collection"</span><span class="p">:</span><span class="w"> </span><span class="s2">"mycollection"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"index"</span><span class="p">:</span><span class="w"> </span><span class="s2">"myindex"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"metadata"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
  </span><span class="nt">"headers"</span><span class="p">:</span><span class="w"> </span><span class="p">{},</span><span class="w">
  </span><span class="nt">"result"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nt">"took"</span><span class="p">:</span><span class="w"> </span><span class="mi">69</span><span class="p">,</span><span class="w">
    </span><span class="nt">"timed_out"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
    </span><span class="nt">"_shards"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nt">"total"</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w">
      </span><span class="nt">"successful"</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w">
      </span><span class="nt">"failed"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nt">"hits"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
      </span><span class="p">{</span><span class="w">
        </span><span class="nt">"_index"</span><span class="p">:</span><span class="w"> </span><span class="s2">"myindex"</span><span class="p">,</span><span class="w">
        </span><span class="nt">"_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"mycollection"</span><span class="p">,</span><span class="w">
        </span><span class="nt">"_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"AVkDLAdCsT6qHI7MxLz4"</span><span class="p">,</span><span class="w">
        </span><span class="nt">"_score"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
        </span><span class="nt">"_source"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nt">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Hey! Ho!"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nt">"_kuzzle_info"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nt">"author"</span><span class="p">:</span><span class="w"> </span><span class="s2">"-1"</span><span class="p">,</span><span class="w">
          </span><span class="nt">"createdAt"</span><span class="p">:</span><span class="w"> </span><span class="mi">1481816934209</span><span class="p">,</span><span class="w">
          </span><span class="nt">"updatedAt"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
          </span><span class="nt">"updater"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
          </span><span class="nt">"active"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
          </span><span class="nt">"deletedAt"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="p">{</span><span class="w">
        </span><span class="nt">"_index"</span><span class="p">:</span><span class="w"> </span><span class="s2">"myindex"</span><span class="p">,</span><span class="w">
        </span><span class="nt">"_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"mycollection"</span><span class="p">,</span><span class="w">
        </span><span class="nt">"_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"AVkDK9iNsT6qHI7MxLz3"</span><span class="p">,</span><span class="w">
        </span><span class="nt">"_score"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
        </span><span class="nt">"_source"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nt">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Hello, world!"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nt">"_kuzzle_info"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nt">"author"</span><span class="p">:</span><span class="w"> </span><span class="s2">"-1"</span><span class="p">,</span><span class="w">
          </span><span class="nt">"createdAt"</span><span class="p">:</span><span class="w"> </span><span class="mi">1481816922252</span><span class="p">,</span><span class="w">
          </span><span class="nt">"updatedAt"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
          </span><span class="nt">"updater"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
          </span><span class="nt">"active"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
          </span><span class="nt">"deletedAt"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="p">{</span><span class="w">
        </span><span class="nt">"_index"</span><span class="p">:</span><span class="w"> </span><span class="s2">"myindex"</span><span class="p">,</span><span class="w">
        </span><span class="nt">"_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"mycollection"</span><span class="p">,</span><span class="w">
        </span><span class="nt">"_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"AVkDLCdRsT6qHI7MxLz5"</span><span class="p">,</span><span class="w">
        </span><span class="nt">"_score"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
        </span><span class="nt">"_source"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nt">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Let's go!"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nt">"_kuzzle_info"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nt">"author"</span><span class="p">:</span><span class="w"> </span><span class="s2">"-1"</span><span class="p">,</span><span class="w">
          </span><span class="nt">"createdAt"</span><span class="p">:</span><span class="w"> </span><span class="mi">1481816942415</span><span class="p">,</span><span class="w">
          </span><span class="nt">"updatedAt"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
          </span><span class="nt">"updater"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
          </span><span class="nt">"active"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
          </span><span class="nt">"deletedAt"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">],</span><span class="w">
    </span><span class="nt">"total"</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w">
    </span><span class="nt">"max_score"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>

<p>Looks neat. Say that now we only want to <strong>query</strong> the documents containing the word <code class="prettyprint">Hey</code> in the <code class="prettyprint">message</code> field. We can achieve this by adding the following query to our body:</p>
<pre class="highlight json"><code><span class="p">{</span><span class="w">
  </span><span class="nt">"query"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nt">"match"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nt">"message"</span><span class="p">:</span><span class="s2">"Hey"</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>

<p>Which gives, as a result, the following response:</p>
<pre class="highlight json"><code><span class="p">{</span><span class="w">
  </span><span class="nt">"status"</span><span class="p">:</span><span class="w"> </span><span class="mi">200</span><span class="p">,</span><span class="w">
  </span><span class="nt">"error"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
  </span><span class="nt">"requestId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"e00cf6d6-8983-498b-8481-96a1fe1b5d46"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"controller"</span><span class="p">:</span><span class="w"> </span><span class="s2">"document"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"action"</span><span class="p">:</span><span class="w"> </span><span class="s2">"search"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"collection"</span><span class="p">:</span><span class="w"> </span><span class="s2">"mycollection"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"index"</span><span class="p">:</span><span class="w"> </span><span class="s2">"myindex"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"metadata"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
  </span><span class="nt">"headers"</span><span class="p">:</span><span class="w"> </span><span class="p">{},</span><span class="w">
  </span><span class="nt">"result"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nt">"took"</span><span class="p">:</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span><span class="w">
    </span><span class="nt">"timed_out"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
    </span><span class="nt">"_shards"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nt">"total"</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w">
      </span><span class="nt">"successful"</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w">
      </span><span class="nt">"failed"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nt">"hits"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
      </span><span class="p">{</span><span class="w">
        </span><span class="nt">"_index"</span><span class="p">:</span><span class="w"> </span><span class="s2">"myindex"</span><span class="p">,</span><span class="w">
        </span><span class="nt">"_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"mycollection"</span><span class="p">,</span><span class="w">
        </span><span class="nt">"_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"AVkDLAdCsT6qHI7MxLz4"</span><span class="p">,</span><span class="w">
        </span><span class="nt">"_score"</span><span class="p">:</span><span class="w"> </span><span class="mf">0.25811607</span><span class="p">,</span><span class="w">
        </span><span class="nt">"_source"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nt">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Hey! Ho!"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nt">"_kuzzle_info"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nt">"author"</span><span class="p">:</span><span class="w"> </span><span class="s2">"-1"</span><span class="p">,</span><span class="w">
          </span><span class="nt">"createdAt"</span><span class="p">:</span><span class="w"> </span><span class="mi">1481816934209</span><span class="p">,</span><span class="w">
          </span><span class="nt">"updatedAt"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
          </span><span class="nt">"updater"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
          </span><span class="nt">"active"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
          </span><span class="nt">"deletedAt"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">],</span><span class="w">
    </span><span class="nt">"total"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
    </span><span class="nt">"max_score"</span><span class="p">:</span><span class="w"> </span><span class="mf">0.25811607</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>

<h4 id="where-do-we-go-from-here">Where do we go from here?</h4>

<ul>
<li>Refer to the <a href="#elasticsearch-cookbook">Elasticsearch cookbook</a> to get more details on how querying works in Kuzzle.</li>
<li>Keep track of the changes on your documents via the <a href="#realtime-notifications">Realtime Notifications</a>.</li>
</ul>

            <h2 id="data-validation">Data Validation</h2>

<p>One common need when you are dealing with data is validation. Every time you create new documents, update them or publish real-time messages, you may want to <strong>check that their content meets a given set of criteria</strong>.</p>

<p>The most common example is the &ldquo;e-mail field validation&rdquo;. Imagine you provide a registration form to your users to collect their name and e-mail. It&rsquo;s quite vital to you that the user provides a valid e-mail address.</p>

<p>Instead of leaving you with the burden of coding this logic, Kuzzle natively provides a way to validate your data input against a validation schema. It enables you to define the set document fields to validate and provides you with <a href="/validation-reference/">an extended set of validation rules</a>.</p>

<p>This way, every time Kuzzle receives a data input, it checks it against the validation schema and returns a <strong>standard error</strong> when the validation fails.</p>

<p>You can specify the validation rules in the kuzzle <a href="/guide/#configuring-kuzzle">configuration file</a> in the <code class="prettyprint">validation</code> field.</p>

<p>You can take a look at the <a href="/validation-reference/">Kuzzle Data Validation Reference</a> for a straight dive, or keep reading for a smoother introduction.</p>

<h3 id="basic-validation">Basic validation</h3>

<p>The place to specify your validation schema is the <code class="prettyprint">validation</code> field in your kuzzlerc file. A validation schema has a <a href="/validation-reference/#schema-structure">hierarchical structure</a>, where you specify a set of rules per collection.</p>
<pre class="highlight json"><code><span class="err">validation:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nt">"onlineshop"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nt">"products"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nt">"id"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="nt">"mandatory"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
                </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"number"</span><span class="w">
            </span><span class="p">},</span><span class="w">
            </span><span class="nt">"productDescription"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w">
                </span><span class="nt">"defaultValue"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Sorry, no description available for this product."</span><span class="w">
            </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>

<p>Let&rsquo;s take a look at what we just did here.</p>

<ul>
<li>We defined a set of rules for the documents contained in the <code class="prettyprint">products</code> collection, within the <code class="prettyprint">onlineshop</code> index.</li>
<li>We specified the field <code class="prettyprint">id</code> as mandatory (which means that it must have a value) and of type <code class="prettyprint">Number</code>.</li>
<li>We specified the field <code class="prettyprint">productDescription</code> as of type <code class="prettyprint">String</code>, with a sorry-ish default value.</li>
</ul>

<p>Take a look at the <a href="/validation-reference/#fields">Validation Fields Reference</a> for a complete insight of all the available specifications.</p>

<h3 id="complex-validation-via-the-dsl">Complex validation via the DSL</h3>

<p>When the validation fields are not enough for your need, you can switch gears and create a complex validation specification via the <a href="/real-time-filters/">filtering DSL</a> (the same DSL used to create real-time subscriptions). The idea is pretty simple: you specify a filter that documents must match in order to be valid.</p>
<pre class="highlight json"><code><span class="err">validation:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nt">"onlineshop"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nt">"products"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nt">"validators"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                </span><span class="err">//</span><span class="w"> </span><span class="err">Here</span><span class="w"> </span><span class="err">goes</span><span class="w"> </span><span class="err">the</span><span class="w"> </span><span class="err">filter</span><span class="w">
                </span><span class="s2">"range"</span><span class="err">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                    </span><span class="nt">"price"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                        </span><span class="nt">"gte"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
                    </span><span class="p">}</span><span class="w">
                </span><span class="p">}</span><span class="w">
            </span><span class="p">]</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>

<p>In the example above, we specified that the value of the attribute <code class="prettyprint">price</code> (of documents contained in the <code class="prettyprint">products</code> collection) must be greater than 0 (because we do not want to make an online shop that gives products away). We leveraged the <code class="prettyprint">range</code> term, that you can look-up in the <a href="/real-time-filters/#range">Real-time filters Reference</a>.</p>

<p>You can take a look at the <a href="/validation-reference/">Kuzzle Data Validation Reference</a> for deeper insight.</p>

            <h2 id="real-time-notifications">Real-time notifications</h2>

<p>Besides persisting data and retrieving it via advanced searches, Kuzzle enables you to set up <strong>live subscriptions</strong> to any set of data.</p>

<p>Live subscriptions are great to <strong>keep track of the evolution</strong> of a portion of your data you are interested in.</p>

<h3 id="introduction">Introduction</h3>

<p>Imagine you are developing <a href="http://kuzzle.io/demos-tutorials/real-time-collaborative-todo-list/">a collaborative TO-DO list</a> application. All the TO-DO items are persisted in Kuzzle (in a collection called <code class="prettyprint">todos</code>) so, once the clients start, they fetch all the items via a simple document search.</p>

<p>But imagine that one of the users (let&rsquo;s call her Ann), adds a new TO-DO item. In order for other users (let&rsquo;s call them Tom and Matt) to display the new item, they need to perform a new document search on the <code class="prettyprint">todos</code> collection. They will not see the new item until they refresh (or restart) their application.</p>

<p>This cannot be called a &ldquo;modern&rdquo; application: it rather looks like an old-school, refresh-ish, one. Like the early &lsquo;90s. Today, such a user-experience wouldn&rsquo;t be satisfying at all.</p>

<p>A more interesting user-experience would be that clients display the new TO-DO item <em>as soon as it is created</em>. How could we achieve that?</p>

<ul>
<li>By implementing a long-polling mechanism in the clients. Every, say, one second, the clients perform a document search and update their list of TO-DO items. Doesn&rsquo;t look like a great idea (performances would be rather bad, for example).</li>
<li>By introducing a <strong>pub/sub</strong> mechanism that enables the backend to <em>push</em> the new item to the clients as soon as it is created (looks awesome, doesn&rsquo;t it?)</li>
</ul>

<p>The second solution is exactly what we are looking for and Kuzzle ships it natively. We can call it <strong>pub/sub</strong>, <strong>real-time notifications</strong> or <strong>live subscriptions</strong> and it is often used to solve use-cases like this one, where things need to be kept <em>in sync</em> between the client and the server.</p>

<p>Our collaborative TO-DO list clients would subscribe to the <code class="prettyprint">todos</code> collection (right after the first document search) in order to be notified <em>in real-time</em> about new TO-DO items. This way, once Ann creates her new item, Tom and Matt see it immediately on their screen.</p>

<h3 id="concepts">Concepts</h3>

<p>Real-time notifications are triggered by the <a href="https://en.wikipedia.org/wiki/Publish%E2%80%93subscribe_pattern">pub/sub mechanism</a> embedded in Kuzzle and follow the <a href="https://en.wikipedia.org/wiki/Observer_pattern">Observer/Observable pattern</a>, in which Kuzzle is the Observable and the client is the Observer.</p>

<p>They are is possible only when the communication happens in a <strong>persistent-connection</strong>-oriented protocol (like Websockets or MQTT) and therefore not in HTTP.</p>

<p>Clients can subscribe to many types of notifications. Below are some examples:</p>

<ol>
<li><strong>new documents</strong> being created in a given collection (e.g. Ann creates a new TO-DO item);</li>
<li><strong>documents being deleted</strong> from a given collection (e.g. Tom deletes a TO-DO item);</li>
<li><strong>changes happening</strong> on any document within a collection (e.g. Matt checks an item as &ldquo;done&rdquo;);</li>
<li><strong>changes happening on a given set of documents</strong> (e.g. clients must play a sound every time an item containing the word &ldquo;URGENT&rdquo; is created).</li>
</ol>

<p>The scope of possibilities is huge. Take a look at the <a href="/api-reference/?others#notifications">Notifications section</a> in the API Reference for more details.</p>

<h3 id="examples">Examples</h3>

<p>But, how does this work in Kuzzle? <strong>How do we select the data that we want to subscribe to?</strong></p>

<p>Let&rsquo;s dive into the implementation of the Collaborative TO-DO list application.</p>

<aside class="notice">
All the following examples are written in Javascript, therefore using the Javascript Kuzzle SDK. If this is not your usual development language, take a look at the different flavors of the `subscribe` method in the [SDK Reference](/sdk-reference/#subscribe).
</aside>

<h4 id="the-basic-subscription">The basic subscription</h4>

<p>Once our client has started and initialized with the set of TO-DO items it fetched from the persistence layer, we want it to subscribe to the changes happening on them.</p>
<pre class="highlight javascript"><code><span class="nx">kuzzle</span>
    <span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">'todos'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">subscribe</span><span class="p">({},</span> <span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">notification</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Something happened and we should do something.'</span><span class="p">,</span> <span class="nx">notification</span><span class="p">)</span>
    <span class="p">})</span>
</code></pre>

<p>This code isn&rsquo;t very useful but it shows the capability to react to a notification coming from the server.</p>

<p>Here, we call the <code class="prettyprint">subscribe</code> method on the <code class="prettyprint">todos</code> collection with two arguments:</p>

<ul>
<li>The first argument represents the <em>filters</em>, and in this case there&rsquo;s none, which means that we are subscribing to <em>all the documents</em> in the collection. Filters enable more fine-grained selection on the data we want to subscribe to and are described in the next example.</li>
<li>The second argument is the <em>callback</em>, i.e. a function that is called <em>every time a notification is received</em>.</li>
</ul>

<p>Now, imagine this code is executed on Tom&rsquo;s client: when Ann creates the new TO-DO item, Tom receives a notification looking like the following:</p>
<pre class="highlight json"><code><span class="p">{</span><span class="w">
  </span><span class="nt">"status"</span><span class="p">:</span><span class="w"> </span><span class="mi">200</span><span class="p">,</span><span class="w">
  </span><span class="nt">"error"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
  </span><span class="nt">"index"</span><span class="p">:</span><span class="w"> </span><span class="s2">"&lt;data index&gt;"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"collection"</span><span class="p">:</span><span class="w"> </span><span class="s2">"&lt;data collection&gt;"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"controller"</span><span class="p">:</span><span class="w"> </span><span class="s2">"document"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"action"</span><span class="p">:</span><span class="w"> </span><span class="s2">"create"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"state"</span><span class="p">:</span><span class="w"> </span><span class="s2">"done"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"scope"</span><span class="p">:</span><span class="w"> </span><span class="s2">"in"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"metadata"</span><span class="p">:</span><span class="w"> </span><span class="p">{},</span><span class="w">
  </span><span class="nt">"requestId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"&lt;unique request identifier&gt;"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"result"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nt">"_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"fswdfsrt43e6t2q3rfw"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"_source"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nt">"label"</span><span class="p">:</span><span class="w"> </span><span class="s2">"The new item Ann just created!"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"checked"</span><span class="p">:</span><span class="w"> </span><span class="s2">"false"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>

<p>The Notification bears some useful information about what just happened:</p>

<ul>
<li>the <code class="prettyprint">controller</code> and <code class="prettyprint">action</code> attributes show <em>what</em> has happened;</li>
<li>the <code class="prettyprint">index</code> and <code class="prettyprint">collection</code> attributes show <em>where</em> it happened;</li>
<li>the <code class="prettyprint">result</code> shows <em>the consequence</em> of what just happened (in this case, the newly created document).</li>
</ul>

<p>We won&rsquo;t analyze the other attributes for the moment. Take a look at the <a href="/api-reference/#notifications">Notifications section of the API Reference</a> for a comprehensive list of the available notification events.</p>

<p>This subscription is very handy and will notify Tom about the events 1, 2 and 3 of the list above (the <code class="prettyprint">controller</code>, <code class="prettyprint">action</code> and <code class="prettyprint">result</code> will vary depending on the case). But what about the event number 4? How does Tom subscribe to items that only contain the word <code class="prettyprint">URGENT</code> in their <code class="prettyprint">label</code> field? Looks like a job for the <a href="/real-time-filters/">Real-time Filtering DSL</a> coming up in the following section.</p>

<h4 id="subscription-with-filters">Subscription with filters</h4>

<p>Kuzzle ships with a powerful <a href="/real-time-filters/">Filtering DSL for Live Subscriptions</a>. It is heavily inspired in the Elasticsearch DSL and enables you to perform fine-grained selections on the documents you want to subscribe to.</p>

<p>In our case, we want to select all the documents that contain the <code class="prettyprint">URGENT</code> word in the <code class="prettyprint">label</code> field. The best pick for this case is the <a href="/real-time-filters/#regexp">regexp</a> filter.</p>
<pre class="highlight javascript"><code><span class="nx">kuzzle</span>
    <span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">'todos'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">subscribe</span><span class="p">({</span>
        <span class="na">regexp</span><span class="p">:</span> <span class="p">{</span>
          <span class="na">label</span><span class="p">:</span> <span class="s1">'.*URGENT.*'</span>
        <span class="p">}</span>
      <span class="p">},</span> <span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">notification</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Something happened and we should do something URGENTLY.'</span><span class="p">,</span> <span class="nx">notification</span><span class="p">)</span>
    <span class="p">})</span>
</code></pre>

<p>This way, Tom will be notified about urgent TO-DO items. Take a look at the <a href="/real-time-filters/">Filtering DSL Refernce</a> for a comprehensive list of the available filters.</p>

<p>There are a few things that deserve to be noticed here:</p>

<ul>
<li>Tom will be notified either if somebody creates, updates or deletes a document containing the word <code class="prettyprint">URGENT</code>;</li>
<li>Tom will be notified even if he performs the actions himself (e.g. he is notified right after having created a new TO-DO item).</li>
</ul>

<p>The last point may seem a little bit inconvenient. What if Tom does not want to receive notifications when the event come from his own actions? Keep reading, the solution is right below.</p>

<h4 id="subscription-with-options">Subscription with options</h4>

<p>The <code class="prettyprint">subscribe</code> method can be called with an extra argument, which is an object containing a set of options to be passed to the subscription Room.</p>

<p>We just introduced a new concept here, the Room. A <a href="/sdk-reference/#room">Room</a> is a class representing a single subscription and its constructor is called internally by the <code class="prettyprint">subscribe</code> method. The &ldquo;options&rdquo; are passed directly to the <a href="/sdk-reference/#constructors82">Room Constructor</a>.</p>

<p>The option we are looking for is <code class="prettyprint">subscribeToSelf</code>, which is set to <code class="prettyprint">true</code> by default.</p>
<pre class="highlight javascript"><code><span class="kd">let</span> <span class="nx">room</span> <span class="o">=</span> <span class="nx">kuzzle</span>
    <span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">'todos'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span>
      <span class="p">{</span> <span class="c1">// The Filters object</span>
        <span class="na">regexp</span><span class="p">:</span> <span class="p">{</span>
          <span class="na">label</span><span class="p">:</span> <span class="s1">'.*URGENT.*'</span>
        <span class="p">}</span>
      <span class="p">},</span>
      <span class="p">{</span> <span class="c1">// The Options object</span>
        <span class="na">subscribeToSelf</span><span class="p">:</span> <span class="kc">false</span>
      <span class="p">},</span>
      <span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">notification</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="c1">// The callback</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Something happened and we should do something URGENTLY.'</span><span class="p">,</span> <span class="nx">notification</span><span class="p">)</span>
    <span class="p">})</span>
</code></pre>

<p>In the code right above, we added the extra &ldquo;options&rdquo; object as the second argument to avoid subscribing Tom to his own events.</p>

<p>You may have noticed that, on the very first line, we stored the return value of the <code class="prettyprint">subscribe</code> method in a variable. Guess what type is its value? <a href="/sdk-reference/#room">Room</a>.</p>

            <h2 id="security">Security</h2>

<p>Kuzzle provides a full set of functionalities to finely define the permissions for your data.</p>

<h3 id="fresh-installation-default-rights">Fresh installation default rights.</h3>

<p>When installing Kuzzle for the very first time, no default user is created and the Anonymous user is allowed to perform any action on the data. The only restriction is on the internal data storage used by Kuzzle to store its configuration.</p>

<p>Once a first admin user is created, either via the <a href="#create-an-admin-account">Kuzzle Back Office</a> or the <a href="#createfirstadmin">CLI</a>, the Anonymous permissions are dropped.</p>

<p>You can then use the Back Office to administrate your user rights.</p>

<h3 id="authentication">Authentication</h3>

<p>The first step to secure your data is to be able to identify your users.
Kuzzle ships by default with a local login/password strategy.</p>

<p>If the &ldquo;local&rdquo; strategy (i.e. storing the users&rsquo; credentials in the local database) doesn&rsquo;t fit your needs, you can use the <a href="https://github.com/kuzzleio/kuzzle-plugin-auth-passport-oauth">Oauth authentication plugin</a>, or develop your own (see <a href="#authentication-process">Core documentation</a> for more details).</p>

<p>If the authentication request identifies an existing user, Kuzzle generates a <a href="https://tools.ietf.org/html/rfc7519">JSON Web Token</a> that must be <a href="/api-reference/#authorization-header">appended to all the subsequent requests</a>.</p>

<aside class="notice">
More information on the login process [here](/api-reference/#login).
</aside>

<h3 id="permissions">Permissions</h3>

<p>Once you know who is connected, you need a way to grant your users with some privileges to control their access to data.</p>

<h4 id="users-profiles-and-roles">Users, profiles and roles</h4>

<p>Kuzzle associates <code class="prettyprint">users</code> to a <code class="prettyprint">profile</code>.<br>
You can think to a <code class="prettyprint">profile</code> as a user group. All the <code class="prettyprint">users</code> that share the same <code class="prettyprint">profile</code> will get the same privileges.</p>

<p>Because some sets of permissions can be shared between several <code class="prettyprint">profiles</code>, Kuzzle includes an additional level of abstraction below the <code class="prettyprint">profile</code>: the <code class="prettyprint">roles</code>.</p>

<p>A <code class="prettyprint">profile</code> is associated to a set of <code class="prettyprint">roles</code>. Each <code class="prettyprint">role</code> defines a set of permissions.</p>

<p><img alt="Users, profiles and roles" src="images/permissions/profiles-roles.png" /></p>

<p>In the simple example above, the <em>editor</em> profile is a superset of the <em>contributor</em> one, which, in turn, extends the <em>default</em> profile.</p>

<p><code class="prettyprint">roles</code> and <code class="prettyprint">profiles</code> can be edited in <a href="https://github.com/kuzzleio/kuzzle-bo">Kuzzle Back Office</a>.</p>

<h4 id="role-definition">Role definition</h4>

<p>A <code class="prettyprint">role</code> definition is a hierarchical JSON object in which permissions can be defined at <code class="prettyprint">controller</code> and <code class="prettyprint">action</code> level.</p>

<p>The <code class="prettyprint">role</code> definition is represented as a Javascript object. Each key at the root of the object identifies a <code class="prettyprint">controller</code> by its name.</p>
<pre class="highlight javascript"><code><span class="kd">var</span> <span class="nx">myRoleDefinition</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">controllers</span><span class="p">:</span> <span class="p">{</span>
    <span class="o">&lt;</span> <span class="nx">controller</span><span class="o">|*</span> <span class="o">&gt;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nl">actions</span><span class="p">:</span> <span class="p">{</span>
        <span class="o">&lt;</span> <span class="nx">action</span><span class="o">|*</span> <span class="o">&gt;</span><span class="p">:</span> <span class="o">&lt;</span> <span class="nx">action</span> <span class="nx">permission</span><span class="o">*</span> <span class="o">&gt;</span><span class="p">,</span>
        <span class="o">&lt;</span> <span class="nx">action</span><span class="o">|*</span> <span class="o">&gt;</span><span class="p">:</span> <span class="o">&lt;</span> <span class="nx">action</span> <span class="nx">permission</span><span class="o">*</span> <span class="o">&gt;</span><span class="p">,</span>
        <span class="p">...</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">};</span>
</code></pre>

<p>Each entry of the <code class="prettyprint">controllers</code>, <code class="prettyprint">actions</code> tree can be set to either an explicit value or the &ldquo;&#42;&rdquo; wildcard.</p>

<p>The <code class="prettyprint">action permission</code> value can be set either to:</p>

<ul>
<li>a boolean. When set to <code class="prettyprint">true</code>, the user is allowed to perform the action.</li>
<li>an object that describes a function (more about it in the <a href="#actions-permissions-functions">action permissions functions section</a>).</li>
</ul>

<p>You can find a <strong>comprehensive summary of all the available controllers</strong> and actions by sending a <code class="prettyprint">GET</code> request to the root endpoint of the Kuzzle API via the HTTP protocol:</p>
<pre class="highlight shell"><code><span class="gp">$ </span>curl -XGET http://localhost:7511/<span class="se">\?</span>pretty<span class="se">\=</span><span class="nb">true</span>
</code></pre>

<p>Take a look at the example below:</p>
<pre class="highlight javascript"><code><span class="kd">var</span> <span class="nx">anonymousRole</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">controllers</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">auth</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">actions</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">login</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
        <span class="na">checkToken</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
        <span class="na">getCurrentUser</span><span class="p">:</span> <span class="kc">true</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">};</span>
</code></pre>

<p>The example above is the permission definition set by Kuzzle for the Anonymous user after the first admin user has been created.</p>

<p>In this example, the role grants the user with the permission to perform the <code class="prettyprint">login</code>, <code class="prettyprint">checkToken</code> and <code class="prettyprint">getCurrentUser</code> actions of the <code class="prettyprint">auth</code> controller.</p>

<h4 id="profile-definition">Profile definition</h4>

<p>A <code class="prettyprint">profile</code> definition is a Javascript object that contains an array of roles, identified by their IDs:</p>
<pre class="highlight javascript"><code><span class="kd">var</span> <span class="nx">myProfileDefinition</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">roles</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span><span class="na">_id</span><span class="p">:</span> <span class="o">&lt;</span> <span class="nx">role</span> <span class="nx">Id</span> <span class="o">&gt;</span> <span class="p">(,</span> <span class="na">restrictedTo</span><span class="p">:</span> <span class="o">&lt;</span> <span class="nx">role</span> <span class="nx">restrictions</span> <span class="o">&gt;</span> <span class="p">)</span> <span class="p">},</span>
    <span class="o">&lt;</span><span class="nx">another</span> <span class="nx">role</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="p">...</span>
  <span class="p">]</span>
<span class="p">};</span>
</code></pre>

<p>A role can be applied globally on the profile, or it can be restricted to a list of indexes or index/collections pairs.</p>

<p>For example, if we have a &ldquo;publisher&rdquo; role which allows to request any action of the <code class="prettyprint">write</code> controller:</p>
<pre class="highlight javascript"><code><span class="kd">var</span> <span class="nx">publisherRole</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">controllers</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">write</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">actions</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">'*'</span><span class="p">:</span> <span class="kc">true</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">};</span>
</code></pre>

<p>Then we declare 3 profiles using this role:</p>
<pre class="highlight javascript"><code><span class="kd">var</span> <span class="nx">profile1</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">roles</span><span class="p">:</span> <span class="p">[</span> <span class="p">{</span><span class="na">_id</span><span class="p">:</span> <span class="s1">'publisherRole'</span> <span class="p">}</span> <span class="p">]</span>
<span class="p">};</span>

<span class="kd">var</span> <span class="nx">profile2</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">roles</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="na">_id</span><span class="p">:</span> <span class="s1">'publisherRole'</span><span class="p">,</span>
      <span class="na">restrictedTo</span><span class="p">:</span> <span class="p">[{</span><span class="na">index</span><span class="p">:</span> <span class="s1">'index1'</span><span class="p">}]</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">};</span>

<span class="kd">var</span> <span class="nx">profile3</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">roles</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="na">_id</span><span class="p">:</span> <span class="s1">'publisherRole'</span><span class="p">,</span>
      <span class="na">restrictedTo</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span><span class="na">index</span><span class="p">:</span> <span class="s1">'index1'</span><span class="p">,</span> <span class="na">collections</span><span class="p">:</span> <span class="p">[</span><span class="s1">'foo'</span><span class="p">,</span> <span class="s1">'bar'</span><span class="p">]},</span>
        <span class="p">{</span><span class="na">index</span><span class="p">:</span> <span class="s1">'index2'</span><span class="p">}</span>
      <span class="p">]</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">};</span>
</code></pre>

<p>With this sample profiles:</p>

<ul>
<li>users with <code class="prettyprint">profile1</code> are allowed to use all <code class="prettyprint">write</code> controller actions on all indexes and collections.</li>
<li>users with <code class="prettyprint">profile2</code> are only allowed to use <code class="prettyprint">write</code> controller actions on collections stored in index <code class="prettyprint">index1</code>.</li>
<li>users with <code class="prettyprint">profile3</code> are only allowed to use <code class="prettyprint">write</code> controller actions on:

<ul>
<li>all collections stored in index <code class="prettyprint">index2</code></li>
<li>collections <code class="prettyprint">foo</code> and <code class="prettyprint">bar</code> stored in index <code class="prettyprint">index1</code>.</li>
</ul></li>
</ul>

<h5 id="composition-rules">Composition rules</h5>

<p>In Kuzzle, permissions follow the <a href="https://en.wikipedia.org/wiki/Whitelist">Whitelist</a> strategy, which means that <strong>an action must be explicitly allowed</strong> by at least one role of the user profile (including restrictions).</p>

<p>That means:
* If a role allows it, the action is authorized, <em>even if another role denies it</em>.
* If no role explicitly allows it, the action if denied, even if no role explicitly denies it as well.</p>

<h4 id="actions-permissions-functions">Actions permissions functions</h4>

<p>So far, we&rsquo;ve seen how to set permissions based on the user profile only.</p>

<p>Now, let&rsquo;s say we have a chat application and want the users to be allowed to edit &amp; delete their own messages only.</p>

<p><strong>This type of rules depends on the context and cannot be expressed as a simple boolean</strong>.</p>

<p>Kuzzle lets you define more complex permissions using custom functions, allowing dynamic decision about whether the user is allowed to proceed or not, depending on the context.</p>

<p>In our chat example, the rule can be expressed as:</p>
<pre class="highlight javascript"><code><span class="kd">var</span> <span class="nx">role</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">controllers</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">write</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">actions</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">create</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
        <span class="na">delete</span><span class="p">:</span> <span class="p">{</span>
          <span class="na">args</span><span class="p">:</span> <span class="p">{</span>
            <span class="na">document</span><span class="p">:</span> <span class="p">{</span>
              <span class="na">index</span><span class="p">:</span> <span class="s2">"$requestObject.index"</span><span class="p">,</span>
              <span class="na">collection</span><span class="p">:</span> <span class="s2">"$requestObject.collection"</span><span class="p">,</span>
              <span class="na">action</span><span class="p">:</span> <span class="p">{</span>
                <span class="na">get</span><span class="p">:</span> <span class="s2">"$currentId"</span>
              <span class="p">}</span>
            <span class="p">}</span>
          <span class="p">},</span>
          <span class="na">test</span><span class="p">:</span> <span class="s2">"return args.document.content.user.id === $currentUserId"</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">};</span>
</code></pre>

<p>See more details at <a href="#permission-closures">Core documentation section</a></p>

            <h2 id="request-and-response-format">Request and Response format</h2>

<p>All transactions in Kuzzle are represented by a <a href="https://github.com/kuzzleio/kuzzle-common-objects#request">Request</a> object. The object is created by the client to send a request to Kuzzle and returned by Kuzzle containing the response.</p>

<p>The state of this object evolves along with the <a href="#lifecycle">lifecycle of the transaction</a>. </p>

<p>The <code class="prettyprint">Request</code> object is <a href="https://developer.mozilla.org/en/docs/Web/JavaScript/Reference/Global_Objects/Object/seal">sealed</a>, which means you cannot add or delete fields once the object is initialized.</p>

<p>Let&rsquo;s take a look at the structure of the <code class="prettyprint">Request</code> object.</p>
<pre class="highlight javascript"><code><span class="nx">Request</span> <span class="p">{</span>
    <span class="c1">// members</span>
    <span class="nx">status</span><span class="p">,</span>     <span class="c1">// {integer}        The status of the transaction (matches HTTP codes)</span>
    <span class="nx">timestamp</span><span class="p">,</span>  <span class="c1">// {integer}</span>
    <span class="nx">id</span><span class="p">,</span>         <span class="c1">// {string}         </span>
    <span class="nx">context</span><span class="p">,</span>    <span class="c1">// {RequestContext} Contains information about the connection and the current token &amp; user</span>
    <span class="nx">input</span><span class="p">,</span>      <span class="c1">// {RequestInput}   The request input params sent by the client</span>
    <span class="nx">result</span><span class="p">,</span>     <span class="c1">// {Object}         The raw result sent by the controller (defaults to null)</span>
    <span class="nx">error</span><span class="p">,</span>      <span class="c1">// {KuzzleError}    Defaults to null</span>
    <span class="nx">response</span><span class="p">,</span>   <span class="c1">// {property}       The final response sent out of Kuzzle (enumerable, get-only property)</span>

    <span class="c1">// methods</span>
    <span class="nx">setError</span> <span class="p">(</span><span class="nx">error</span><span class="p">),</span>               <span class="c1">// Sets the status to the error.code and fills the error member.</span>
    <span class="nx">setResult</span> <span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="p">[</span><span class="nx">status</span><span class="o">=</span><span class="mi">200</span><span class="p">])</span>   <span class="c1">// Sets the result and the status code.</span>
<span class="p">}</span>
</code></pre>

<p>Let&rsquo;s take a look at the attributes of this object.</p>

<ul>
<li>The <code class="prettyprint">id</code> attribute bears a unique, auto-generated value that identifies the transaction.</li>
<li>The <code class="prettyprint">timestamp</code> attribute stores the creation date (in seconds after the Epoch time).</li>
</ul>

<h3 id="input">Input</h3>

<p>The <code class="prettyprint">input</code> field contains all the parameters that express the request from the client. It has the following structure:</p>
<pre class="highlight javascript"><code><span class="nx">RequestInput</span> <span class="p">{</span>
    <span class="c1">// members</span>
    <span class="nx">args</span><span class="p">,</span>           <span class="c1">// {Object}     Parametric arguments. i.e. for REST, taken from the query string</span>
    <span class="nx">metadata</span><span class="p">,</span>       <span class="c1">// {Object}</span>
    <span class="nx">body</span><span class="p">,</span>           <span class="c1">// {Object}     Content of the resource for REST like routes, main parameters for others</span>
    <span class="nx">controller</span><span class="p">,</span>     <span class="c1">// {string}</span>
    <span class="nx">action</span><span class="p">,</span>         <span class="c1">// {string}</span>
    <span class="nx">resource</span> <span class="p">{</span>
        <span class="nx">index</span><span class="p">,</span>
        <span class="nx">collection</span><span class="p">,</span>
        <span class="nx">_id</span>
    <span class="p">}</span>

    <span class="c1">// methods</span>
    <span class="nx">constructor</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="c1">// data is a JS Object that has the same structure as the Websocket message</span>
<span class="p">}</span>
</code></pre>

<h3 id="context">Context</h3>

<p>The <code class="prettyprint">context</code> attribute contains information about the state of the connection at the moment the request is sent. It has the following structure:</p>
<pre class="highlight javascript"><code><span class="nx">RequestContext</span> <span class="p">{</span>
    <span class="nx">connectionId</span><span class="p">,</span>   <span class="c1">// {scalar}     Unique identifier of the user connection</span>
    <span class="nx">protocol</span><span class="p">,</span>       <span class="c1">// {string}</span>
    <span class="nx">token</span><span class="p">,</span>          <span class="c1">// {Token}      Auth token</span>
    <span class="nx">user</span>            <span class="c1">// {User}       Represents the current User associated to the transaction</span>
<span class="p">}</span>
</code></pre>

<h3 id="status-codes">Status codes</h3>

<p>The <code class="prettyprint">status</code> attribute is a numeric code similar to <a href="https://en.wikipedia.org/wiki/List_of_HTTP_status_codes">HTTP status codes</a>.
It is used to inform the client about the real status of his request (if an error occurred or not).</p>

<h4 id="list-of-status-codes-supported-by-kuzzle">List of status codes supported by Kuzzle</h4>

<h5 id="1xx-processing">1xx Processing</h5>

<ul>
<li><code class="prettyprint">102</code>: Standard status for an unhandled request.</li>
</ul>

<h5 id="2xx-success">2xx Success</h5>

<ul>
<li><code class="prettyprint">200</code>: Standard status for a successful request.</li>
<li><code class="prettyprint">206</code>: The request (typically a bulk import) is partially successful, but some actions encountered an error.
(in this case, error details are returned within <em>error.errors</em>)</li>
</ul>

<h5 id="4xx-client-error">4xx Client Error</h5>

<ul>
<li><code class="prettyprint">400</code>: The request is malformed (usually: an argument is missing).</li>
<li><code class="prettyprint">403</code>: The client is not allowed to perform the requested action.</li>
<li><code class="prettyprint">404</code>: The requested resource cannot be found.</li>
</ul>

<h5 id="5xx-server-error">5xx Server Error</h5>

<ul>
<li><code class="prettyprint">500</code>: Kuzzle encountered an unexpected error (standard code for internal error).</li>
<li><code class="prettyprint">503</code>: An external service is unavailable</li>
</ul>

<h3 id="error-objects-format">Error objects format</h3>

<p>When an error occurred, the <code class="prettyprint">error</code> attribute contains <a href="https://github.com/kuzzleio/kuzzle-common-objects/blob/master/README.md#errorskuzzleerror">KuzzleError</a> object, which inherits from the primitive Javascript <code class="prettyprint">Error</code> type.</p>

<h3 id="life-cycle">Life-cycle</h3>

<p>Here is how it works.</p>

<ul>
<li>The client initializes the object with the arguments passed to the <a href="https://github.com/kuzzleio/kuzzle-common-objects#new-requestdata-options">constructor</a>.

<ul>
<li>The <code class="prettyprint">status</code> field is always initialized to 102 (&ldquo;processing&rdquo;).</li>
<li>The <code class="prettyprint">context</code> field is initialized with the connection status and ID.</li>
<li>The <code class="prettyprint">input</code> field is initialized with the request parameters specified in the options.</li>
<li>The fields <code class="prettyprint">error</code>, <code class="prettyprint">result</code> and <code class="prettyprint">response</code> contain <code class="prettyprint">null</code>.</li>
</ul></li>
<li>Kuzzle receives the response. The corresponding controller handles it according to the <code class="prettyprint">input</code> field.

<ul>
<li>The raw response of the controller is set to the <code class="prettyprint">result</code> field.</li>
<li>If an error occurs, Kuzzle updates the <code class="prettyprint">error</code> field via the <code class="prettyprint">setError</code> method.</li>
<li>The <code class="prettyprint">status</code> field is update consequently with a HTTP-compliant numeric code.</li>
<li>Kuzzle fills the <code class="prettyprint">response</code> field with an object compliant with the <a href="/api-reference/?websocket#kuzzle-response">Kuzzle Response API standard</a></li>
</ul></li>
<li>Kuzzle sends the response back to the client.</li>
</ul>

            <h2 id="command-line-interface">Command Line Interface</h2>

<p>Kuzzle ships with a <a href="https://en.wikipedia.org/wiki/Command-line_interface">Command line interface</a> which enables you to:</p>

<ul>
<li>start and stop Kuzzle Core,</li>
<li>install and configure plugins,</li>
<li>create the first administrator user,</li>
<li>reset Kuzzle internal data <em>(use with caution !)</em>.</li>
</ul>

<aside class="warning">
If you are running Kuzzle in a Docker container, you will have to [enter the Kuzzle container](https://docs.docker.com/engine/reference/commandline/exec/) to run these commands.
</aside>
<pre class="highlight shell"><code><span class="gp">$ </span>./bin/kuzzle

  Usage: kuzzle <span class="o">[</span>options] <span class="o">[</span><span class="nb">command</span><span class="o">]</span>


  Commands:

    createFirstAdmin          create the first administrator user
    clearCache                clear internal caches <span class="k">in </span>Redis
    plugins <span class="o">[</span>options] <span class="o">[</span>name]  manage plugins
    reset <span class="o">[</span>options]           delete Kuzzle configuration and users from database
    start <span class="o">[</span>options]           start a Kuzzle instance
    dump                      create a dump of current state of Kuzzle

  Options:

    -h, --help      output usage information
    -V, --version   output the version number
    -d, --debug     make errors more verbose
    -C, --noColors  <span class="k">do </span>not use ANSI coloring

</code></pre>

<h3 id="createfirstadmin">createFirstAdmin</h3>
<pre class="highlight shell"><code><span class="gp">$ </span>./bin/kuzzle createFirstAdmin
</code></pre>

<p>When Kuzzle runs for the first time, no users are defined and the anonymous user is granted with super-admin rights.</p>

<p>The <code class="prettyprint">createFirstAdmin</code> command lets you define an administrator user and set your own permissions.</p>

<aside class="notice">NB: This command can only be run interactively</aside>

<h3 id="clearcache">clearCache</h3>
<pre class="highlight shell"><code><span class="gp">$ </span>./bin/kuzzle clearCache
</code></pre>

<p>Kuzzle relies on the Redis service to store some frequently accessed internal data. If you need to restart Kuzzle with a fresh cache, this command can come in hand.</p>

<h3 id="plugins">plugins</h3>

<p>Please refer to the <a href="#managing-plugins-using-the-cli">dedicated plugin CLI documentation</a>.</p>

<h3 id="reset">reset</h3>
<pre class="highlight plaintext"><code>$ ./bin/kuzzle reset --help

    Usage: reset [options]

    delete Kuzzle configuration and users from database

    Options:

      -h, --help             output usage information
      --fixtures &lt;fixtures&gt;  import some fixtures from file
      --mappings &lt;mappings&gt;  load and apply mappings from file
      --noint                non interactive mode
</code></pre>

<p>The <code class="prettyprint">reset</code> command deletes all currently set configurations and users from the database.</p>

<p>If business data were imported in Kuzzle&rsquo;s database layer, these are kept intact.</p>

<h3 id="start">start</h3>
<pre class="highlight plaintext"><code>$ ./bin/kuzzle start --help

    Usage: start [options]

    start a Kuzzle instance

    Options:

      -h, --help                 output usage information
      -p, --port &lt;port&gt;          Kuzzle port number
          --fixtures &lt;fixtures&gt;  import some fixtures from file
          --mappings &lt;mappings&gt;  load and apply mappings from file
</code></pre>

<p>The <code class="prettyprint">start</code> command starts a Kuzzle server in the foreground.</p>

<h3 id="dump">dump</h3>
<pre class="highlight shell"><code><span class="gp">$ </span>./bin/kuzzle dump --help
<span class="o">[</span>ℹ] Creating dump file...
<span class="o">[</span>✔] Done!

<span class="o">[</span>ℹ] Dump has been successfully generated <span class="k">in</span> <span class="s2">"dump/20161214-1555-cli"</span> folder
<span class="o">[</span>ℹ] You can send the folder to the kuzzle core team at support@kuzzle.io
</code></pre>

<p>The <code class="prettyprint">dump</code> command creates a snapshot of the state of Kuzzle. It includes
* a core dump of Kuzzle Core,
* a dump of the main configuration,
* a dump of all the server logs,
* a dump of the Node.js engine properties,
* a dump of the OS properties,
* a dump of the plugins configuration,
* a dump of the usage statistics of the Kuzzle Server.</p>

<p>This can be particularly handy to feed a crash report to the support team if you own a Kuzzle License.</p>

            <h2 id="the-plugin-system">The Plugin System</h2>

<p>Being able to grab a full-feature backend and run it quickly is very convenient, but Kuzzle is about more than that. As soon as you start developing real-life applications that live out in the wild, you need to <strong>extend your backend with your own business-logic</strong>.
That&rsquo;s quite legitimate: some logic is sensible and cannot live on the client.</p>

<p>For example, imagine your application needs to leverage a <strong>third-party payment system</strong>, such as Braintree. You don&rsquo;t want to put the client in charge of bearing API keys and tokens. Also, you will probably want to <strong>keep track of orders</strong> and payments, once the transactions successfully end. This should be also a concern of your backend. Also, you are not likely to allow your customers to purchase more items than available, right? At some point, <strong>your backend has to validate the transaction</strong> by comparing the ordered quantity with the available stocks.</p>

<p>To solve this problem, Kuzzle ships with a powerful <strong><a href="/plugin-reference">Plugin System</a></strong> that enables you to add features to your server in a modular fashion. With Kuzzle Plugins you can</p>

<ul>
<li>use an existing plugin from the Kuzzle Plugins ecosystem (such as the <a href="https://github.com/kuzzleio/kuzzle-plugin-auth-passport-oauth">OAuth2 Authentication strategy</a> or the <a href="https://github.com/kuzzleio/kuzzle-plugin-mqtt">MQTT Protocol</a>);</li>
<li><a href="/plugin-reference/#writing-plugin-code">create your own plugin</a> from scratch.</li>
</ul>

<h3 id="plugin-types">Plugin Types</h3>

<p>There are three main Plugin types, each one has specific features.</p>

<h4 id="core-plugins">Core Plugins</h4>

<p>They are the most common type of plugins and are meant to extend the Kuzzle Core features. They are plugged on the Kuzzle Core at startup and execute on its same thread. A Core Plugin can extend Kuzzle with the following features:</p>

<p><a href="/plugin-reference#listener-plugins">Listen asynchronously</a>, and perform operations that depend on data-related events. The chunk of data involved with the event is passed to the triggered callback, but the Kuzzle Core continues its execution without waiting for the callback to return, nor receiving the return value of the callback.</p>

<p><em>Example - &ldquo;Write a log to a third-party log system every time a document is deleted&rdquo;</em>. The <a href="https://github.com/kuzzleio/kuzzle-plugin-logger">Logger Plugin</a>, shipped with Kuzzle, uses this feature to log all the data-related events.</p>

<p><a href="/plugin-reference#pipe-plugins">Listen synchronously</a>, and perform operations that depend on data-related events. many synchronous listeners can be chained, forming a pipeline. The chunk of data involved with the event is passed to the plugin pipeline and can be modified. The Kuzzle Core waits for the pipeline to return and receives the returned value (which must be the processed chunk of data). The pipeline can even stop a request life-cycle, returning a standard Error to the Kuzzle Core.</p>

<p><em>Example - &ldquo;Compare the ordered quantity with the available stocks and return an error if ordered is greater than stocks&rdquo;</em>.</p>

<p><a href="/plugin-reference#controllers">Add a controller route</a> to expose new actions to the API.</p>

<p><em>Example - &ldquo;Expose a <code class="prettyprint">checkout</code> API endpoint that handles the Braintree payment process&rdquo;</em>.</p>

<p><a href="/plugin-reference#authentication-plugin">Add an authentication strategy</a> the User authentication system.</p>

<p><em>Example - &ldquo;Enable Kuzzle to authenticate users via the OAuth strategy&rdquo;</em>
  Kuzzle ships with an Authentication Plugin already bundled in its Community Edition, the <a href="https://github.com/kuzzleio/kuzzle-plugin-auth-passport-local">Local Strategy Plugin</a>.</p>

<h4 id="worker-plugins">Worker Plugins</h4>

<p><a href="/plugin-reference#worker-plugins">Workers Plugins</a> are Core Plugins that run on a separate process. The only feature they can add is to <a href="/plugin-reference#listener-plugins">asynchronously listen to data-related events</a>. They are useful when performing costly operations as they have no impact on Kuzzle performances.</p>

<p><em>Example - &ldquo;Compute a complex data-mining operation and commit the result to a third-party Business-Intelligence platform every time a document is changed&rdquo;.</em></p>

<h4 id="protocol-plugins">Protocol Plugins</h4>

<p><a href="/plugin-reference#protocol-plugins">Protocol Plugins</a> extend Kuzzle networking capabilities by adding new network protocols.</p>

<p><em>Example - &ldquo;Enable Kuzzle to interact with XMPP-oriented services&rdquo;</em>
Kuzzle ships with a Protocol Plugin already bundled in its Community Edition, the <a href="https://github.com/kuzzleio/kuzzle-plugin-websocket">Websocket Plugin</a>.</p>

<h3 id="examples">Examples</h3>

<p>This example is a very dummy one. We are going to install the <strong>Hello World Controller Plugin</strong>, which opens a new API endpoint that simply&hellip; Greets the client! Not very useful, except for the sake of this example.</p>

<p>In Kuzzle, you can use the CLI to manage your Plugins. The <code class="prettyprint">plugins --install</code> command enables you to install a Plugin from a Git repository, an NPM package or a local path on your machine.</p>

<aside class="notice">
If you are running Kuzzle in a Docker container, you will need to enter the container to use the CLI.
</aside>

<p>Go to the Kuzzle installation directory and type:</p>
<pre class="highlight shell"><code><span class="gp">$ </span>bin/kuzzle plugins --install --url https://github.com/kuzzleio/kuzzle-plugin-helloworld.git
<span class="gp">$ </span>pm2 restart KuzzleServer
</code></pre>

<p>Once Kuzzle has restarted (that&rsquo;s what the second command is for) you can check the server information at <code class="prettyprint">http://localhost:7511/?pretty=true</code> for the new <code class="prettyprint">hello</code> endpoint:</p>
<pre class="highlight json"><code><span class="p">{</span><span class="w">
    </span><span class="err">...</span><span class="w">
    </span><span class="nt">"result"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nt">"serverInfo"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nt">"kuzzle"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="err">...</span><span class="w">
                </span><span class="nt">"api"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                    </span><span class="nt">"routes"</span><span class="p">:</span><span class="w">
                    </span><span class="err">...</span><span class="w">
                    </span><span class="s2">"kuzzle-plugin-helloworld/hello"</span><span class="err">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                      </span><span class="nt">"sayHello"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                        </span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"sayHello"</span><span class="w">
                      </span><span class="p">}</span><span class="w">
                    </span><span class="p">}</span><span class="w">
                </span><span class="p">}</span><span class="w">
            </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">

</span></code></pre>

<p>Which means you can call the <code class="prettyprint">http://localhost:7511/kuzzle-plugin-helloworld/hello/</code> route and get the following response:</p>
<pre class="highlight json"><code><span class="p">{</span><span class="w">
  </span><span class="nt">"requestId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"66265614-e908-4a91-a492-135e40e64aa3"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"status"</span><span class="p">:</span><span class="w"> </span><span class="mi">200</span><span class="p">,</span><span class="w">
  </span><span class="nt">"error"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
  </span><span class="nt">"controller"</span><span class="p">:</span><span class="w"> </span><span class="s2">"kuzzle-plugin-helloworld/hello"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"action"</span><span class="p">:</span><span class="w"> </span><span class="s2">"sayHello"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"collection"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
  </span><span class="nt">"index"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
  </span><span class="nt">"metadata"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
  </span><span class="nt">"result"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Hello world"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>

<p>To get a deeper insight on how Plugins work in Kuzzle, please refer to the <a href="/plugin-reference">Plugin Reference</a>.</p>

<h3 id="managing-plugins-using-the-cli">Managing plugins using the CLI</h3>

<p>Plugins can be managed using the Kuzzle command-line interface:</p>
<pre class="highlight plaintext"><code>$ ./bin/kuzzle plugins --help

  Usage: plugins [options] [name]

  manage plugins

  Options:

    -h, --help                      output usage information
        --list                      list currently installed plugins
        --install                   if plugin [name] is provided, install it from --version, --url or --path, otherwise, (re-)install all listed plugins
        --remove                    remove plugin [name] from Kuzzle
        --activate                  mark the plugin as "activated"
        --deactivate                mark the plugin as "deactivated"
        --importConfig &lt;file&gt;       import plugin [name] configuration from &lt;file&gt;
        --get                       get plugin [name] configuration stored in Kuzzle
        --set &lt;JSONObject&gt;          merge plugin [name] configuration with JSONObject
        --unset &lt;property&gt;          unset property from the plugin configuration
        --replace &lt;JSONObject&gt;      erase the plugin configuration and apply JSONObject instead
    -v, --packageVersion &lt;version&gt;  plugin &lt;version&gt; to install (npm repository or git only)
    -u, --url &lt;url&gt;                 install plugin from a git repository or a remote tarball
    -p, --path &lt;path&gt;               install plugin from the file system

</code></pre>

<aside class="warning">Restarting Kuzzle is required to apply any change made to plugins using the command-line interface</aside>

<h4 id="list-installed-plugins">List installed plugins</h4>

<aside class="note">Installed plugins are copied into the node_modules directory of a Kuzzle server instance, even if installed from a directory path</aside>

<p>You can get an overview of installed plugins and their activation status using the <code class="prettyprint">--list</code> option:</p>
<pre class="highlight plaintext"><code>./bin/kuzzle plugins --list
{ 'kuzzle-plugin-logger':
   { version: '2.0.4',
     activated: true,
     config:
      { services:
         { file:
            { outputs: { error: { level: 'warn', filename: 'kuzzle.log' } },
              addDate: true },
           stdout: { level: 'info' } } } },
  'kuzzle-plugin-auth-passport-local':
   { version: '2.0.4',
     activated: true,
     config: { secret: 'changeme', algorithm: 'sha1', digest: 'hex' } } }
</code></pre>

<h4 id="install-a-plugin">Install a plugin</h4>

<p>Kuzzle CLI supports most <a href="https://docs.npmjs.com/cli/install">npm installation methodes</a>.</p>

<h5 id="from-npm-repositories">from npm repositories</h5>
<pre class="highlight shell"><code><span class="gp">$ </span>kuzzle plugins --install <span class="o">[</span>--packageVersion x.y.z] name
</code></pre>

<p>If <code class="prettyprint">--packageVersion</code> is not provided, the <code class="prettyprint">latest</code> version will be installed.</p>

<h5 id="from-a-git-repository">from a git repository</h5>
<pre class="highlight shell"><code><span class="gp">$ </span>kuzzle plugins --install <span class="o">[</span>--packageVersion commit-ish] --url https://git.repository.url/project.git
</code></pre>

<p>The version can be anything related to commits: branch, tag, commit sha1.</p>

<p>If no version is provided, the <code class="prettyprint">master</code> branch is used.</p>

<h5 id="from-a-remote-tarball">from a remote tarball</h5>
<pre class="highlight shell"><code><span class="gp">$ </span>kuzzle plugins --install --url http://remote.com/plugin.tar.gz
</code></pre>

<aside class="note">The tarball will be decompressed in the node_modules directory</aside>

<h5 id="from-a-local-tarball">from a local tarball</h5>
<pre class="highlight shell"><code><span class="gp">$ </span>kuzzle plugins --install --path /path/to/plugin.tar.gz
</code></pre>

<aside class="note">The tarball will be decompressed in the node_modules directory</aside>

<h5 id="from-a-local-directory">from a local directory</h5>
<pre class="highlight shell"><code><span class="gp">$ </span>kuzzle plgins --install --path /path/to/plugin
</code></pre>

<aside class="note">The directory content will be copied in the node_modules directory</aside>

<h4 id="view-plugins-configuration">View plugins configuration</h4>

<p>To view a plugin configuration, use the <code class="prettyprint">--get</code> option.</p>
<pre class="highlight plaintext"><code>$ ./bin/kuzzle plugins --get kuzzle-plugin-logger
{ npmVersion: '2.0.2',
  activated: true,
  config:
   { services:
      { file:
         { outputs:
            { error: { level: 'error', filename: 'kuzzle-error.log' },
              warning: { level: 'warn', filename: 'kuzzle-warning.log' } },
           addDate: true },
        stdout: { level: 'info', addDate: true } } } }
</code></pre>

<h4 id="modify-a-plugin-configuration">Modify a plugin configuration</h4>

<p>Plugin configurations are stored in the <code class="prettyprint">config</code> part of plugins properties.</p>

<p>There are multiple ways of changing a plugin configuration:</p>

<ul>
<li>perform a partial update, using the <code class="prettyprint">--set</code> action. This allows adding or updating parts of the configuration</li>
<li>replace the entire plugin configuration on the command-line, with the <code class="prettyprint">--replace</code> action</li>
<li>replace the entire plugin configuration by loading a JSON file, with the <code class="prettyprint">--importConfig &lt;file&gt;</code> action</li>
</ul>

<p>Updating a plugin configuration:</p>
<pre class="highlight plaintext"><code>$ ./bin/kuzzle plugins --get kuzzle-plugin-logger
{ version: '2.0.4',
  activated: true,
  config:
   { services:
      { file:
         { outputs: { error: { level: 'warn', filename: 'kuzzle.log' } },
           addDate: true },
        stdout: { level: 'info' } } } }
$ ./bin/kuzzle plugins --set '{ "stdout": { "level": "debug"} }' kuzzle-plugin-logger
{ version: '2.0.4',
  activated: true,
  config:
   { services:
      { file:
         { outputs: { error: { level: 'warn', filename: 'kuzzle.log' } },
           addDate: true },
        stdout: { level: 'info' } },
     stdout: { level: 'debug' } } }
</code></pre>

<p>Replacing a plugin configuration on the command-line:</p>
<pre class="highlight plaintext"><code>$ ./bin/kuzzle plugins --get kuzzle-plugin-logger

{ version: '2.0.4',
  activated: true,
  config:
   { services:
      { file:
         { outputs: { error: { level: 'warn', filename: 'kuzzle.log' } },
           addDate: true },
        stdout: { level: 'info' } } } }
$ ./bin/kuzzle plugins --replace '{"stdout": {"level": "debug", "addDate": true}}' kuzzle-plugin-logger

{ version: '2.0.4',
  activated: true,
  config: { stdout: { level: 'debug', addDate: true } } }
</code></pre>

<p>Replacing a plugin configuration using a JSON file:</p>
<pre class="highlight plaintext"><code>$ ./bin/kuzzle plugins --importConfig foo.json kuzzle-plugin-logger
[✔] Successfully imported configuration
$ ./bin/kuzzle plugins --get kuzzle-plugin-logger
{ npmVersion: '2.0.4', activated: true, config: { foo: 'bar' } }
</code></pre>

<h4 id="removing-a-plugin-configuration-property">Removing a plugin configuration property</h4>

<p>You can remove a plugin configuration property by using the <code class="prettyprint">--unset</code> action:</p>
<pre class="highlight plaintext"><code>$ ./bin/kuzzle plugins --get kuzzle-plugin-logger
{ version: '2.0.4',
  activated: true,
  config:
   { services:
      { file:
         { outputs:
            { error: { level: 'error', filename: 'kuzzle-error.log' },
              warning: { level: 'warn', filename: 'kuzzle-warning.log' } },
           addDate: true },
        stdout: { level: 'info', addDate: true } } } }
$ ./bin/kuzzle plugins --unset 'services' kuzzle-plugin-logger
  { npmVersion: '2.0.4',
    activated: true }
</code></pre>

<aside class="notice">NB: Only root properties can be unset</aside>

<h4 id="uninstalling-a-plugin">Uninstalling a plugin</h4>

<p>Plugins can be uninstalled using the <code class="prettyprint">--remove</code> option.</p>
<pre class="highlight shell"><code><span class="gp">$ </span>kuzzle plugins --remove kuzzle-plugin-socketio
<span class="o">{</span> acknowledged: <span class="nb">true</span> <span class="o">}</span>
</code></pre>

<h4 id="activating-deactivating-a-plugin">Activating/Deactivating a plugin</h4>

<p>By default, a plugin is activated when installed, meaning it will be loaded and used by Kuzzle on the next restart.</p>

<p>You may want to activate or deactivate a plugin, without uninstalling it.</p>

<p>To deactivate a plugin:</p>
<pre class="highlight plaintext"><code>./bin/kuzzle plugins --deactivate kuzzle-plugin-logger
{ version: '2.0.4',
  activated: false,
  config:
   { services:
      { file:
         { outputs:
            { error: { level: 'error', filename: 'kuzzle-error.log' },
              warning: { level: 'warn', filename: 'kuzzle-warning.log' } },
           addDate: true },
        stdout: { level: 'info', addDate: true } } } }
</code></pre>

<p>To activate a plugin:</p>
<pre class="highlight plaintext"><code>$ ./bin/kuzzle plugins --activate kuzzle-plugin-logger
  { version: '2.0.4',
    activated: true,
    config:
     { services:
        { file:__
           { outputs:
              { error: { level: 'error', filename: 'kuzzle-error.log' },
                warning: { level: 'warn', filename: 'kuzzle-warning.log' } },
             addDate: true },
          stdout: { level: 'info', addDate: true } } } }
</code></pre>

            <h1 id="kuzzle-in-depth">Kuzzle in depth</h1>

<p>In this section we&rsquo;ll take a deeper look at the Kuzzle Core internals.</p>

<p><img alt="archi_core" src="images/core-architecture.png" /></p>

<h2 id="components">Components</h2>

<p>The above schema shows the main architecture in Kuzzle, which is composed of the following entities.</p>

<ul>
<li><strong>Kuzzle Proxy</strong>: handles the communication beetween the client and Kuzzle (see <a href="/api-reference/#connecting-to-kuzzle">Connecting to kuzzle</a>), and forwards the input message to the Router.</li>
<li><strong>Router</strong>: exposes the API routes, normalizes the Request and sends them to the Funnel.</li>
<li><strong>Funnel</strong>: analyses the Request and forwards it to the appropriate Controller.</li>
<li><strong>Controllers</strong>: handle the Request (see <a href="/api-reference">API reference</a>) and return a response (or an error).</li>
<li><strong>Internal Components</strong>: Any component internally accessed by controllers.</li>
<li><strong>Service Components</strong>: Any component used to interact with external services (see <a href="#services">below</a>).</li>
</ul>

<h2 id="services">Services</h2>

<p>In Kuzzle, a Service module is the implementation of the interface to different components of the application (think of a <em>system</em> service).</p>

<p>Kuzzle currently implements the following Services:</p>

<ul>
<li><a href="https://github.com/kuzzleio/kuzzle/blob/master/lib/services/elasticsearch.js">elasticsearch.js</a>: interface to <a href="https://www.elastic.co/products/elasticsearch">Elasticsearch</a>, used for persistent data storage.</li>
<li><a href="https://github.com/kuzzleio/kuzzle/blob/master/lib/services/redis.js">redis.js</a>: interface to the <a href="http://redis.io">redis</a> cache server.</li>
<li><a href="https://github.com/kuzzleio/kuzzle/blob/master/lib/services/proxyBroker.js">proxyBroker.js</a>: interface with the proxy.</li>
<li><a href="https://github.com/kuzzleio/kuzzle/blob/master/lib/services/broker">Broker Client and Server</a>: implementation of the internal message broker.</li>
<li><a href="https://github.com/kuzzleio/kuzzle/blob/master/lib/services/internalEngine.js">internalEngine.js</a>: light interface with the internal index (containing kuzzle&rsquo;s configuration) in Elastic Search.</li>
</ul>

<p>A Service can be added to different engines. For example, Redis is used by both the internalCache and the memoryStorage (see <a href="https://github.com/kuzzleio/kuzzle/blob/master/default.config.js">default.config.js</a>).</p>

            <h2 id="request-life-cycle">Request Life-Cycle</h2>

<p>In this section we are going to focus on how Requests flow between Kuzzle components. We are going to analyze the life-cycle of a Request in order to understand in depth the Kuzzle Core architecture.</p>

<h3 id="reading-content-from-kuzzle">Reading content from Kuzzle</h3>

<p>By &ldquo;reading&rdquo;, we mean any action involving getting content from the persistent layer: getting a single document, count documents, or search contents with advanced filters.</p>

<h4 id="http-request">HTTP Request</h4>

<p>The schema below shows the <a href="#kuzzle-in-depth">Architecture overview</a> showed above and highlights the components involved in reading actions:</p>

<p><img alt="read_scenario_http_overview" src="images/request-scenarios/read-http/overview.png" /></p>

<p>The following diagram shows how the Request flows between the client application, the different Kuzzle components, and the external services:</p>

<p><img alt="read_scenario_http_details" src="images/request-scenarios/read-http/details.png" /></p>

<ul>
<li>The HTTP client asks for a document via a HTTP GET Request. For instance, to retrieve the document &lsquo;739c26bc-7a09-469a-803d-623c4045b0cb&rsquo; in the collection <code class="prettyprint">users</code>: <code class="prettyprint">GET http://kuzzle:7511/mainindex/users/739c26bc-7a09-469a-803d-623c4045b0cb</code>.</li>
<li>The proxy forwards the Request through the HTTP Entry point to the Router, which handles it and forwards the formatted Request to the Funnel.</li>
</ul>

<p>The formatted Request <code class="prettyprint">input</code> looks like the following:</p>
<pre class="highlight json"><code><span class="p">{</span><span class="w">
  </span><span class="nt">"controller"</span><span class="p">:</span><span class="w"> </span><span class="s2">"read"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"action"</span><span class="p">:</span><span class="w"> </span><span class="s2">"get"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"resource"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nt">"index"</span><span class="p">:</span><span class="w"> </span><span class="s2">"mainindex"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"collection"</span><span class="p">:</span><span class="w"> </span><span class="s2">"users"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"739c26bc-7a09-469a-803d-623c4045b0cb"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>

<ul>
<li>The Funnel Controller validates the data before sending the request to the Document Controller.</li>
<li>The Document Controller calls the Read Engine service.</li>
<li>The Read Engine service performs an HTTP request to get the data from the data storage.</li>
</ul>

<p>The content returned by Elasticsearch looks like the following:</p>
<pre class="highlight json"><code><span class="p">{</span><span class="w">
  </span><span class="nt">"_index"</span><span class="p">:</span><span class="w"> </span><span class="s2">"mainindex"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"users"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"739c26bc-7a09-469a-803d-623c4045b0cb"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"_version"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
  </span><span class="nt">"found"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
  </span><span class="nt">"_source"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nt">"firstName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Grace"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"lastName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Hopper"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"age"</span><span class="p">:</span><span class="w"> </span><span class="mi">85</span><span class="p">,</span><span class="w">
      </span><span class="nt">"location"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nt">"lat"</span><span class="p">:</span><span class="w"> </span><span class="mf">32.692742</span><span class="p">,</span><span class="w">
          </span><span class="nt">"lon"</span><span class="p">:</span><span class="w"> </span><span class="mf">-97.114127</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nt">"city"</span><span class="p">:</span><span class="w"> </span><span class="s2">"NYC"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"hobby"</span><span class="p">:</span><span class="w"> </span><span class="s2">"computer"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>

<ul>
<li>Promises functions are resolved to forward the response message back to the HTTP Router.</li>
<li>The HTTP Router sends the response to the HTTP client.</li>
</ul>

<h4 id="websocket-connection">Websocket connection</h4>

<p>The schema below shows the <a href="#kuzzle-in-depth">Architecture overview</a> showed above and highlights the components involved in reading actions:</p>

<p><img alt="read_scenario_websocket_overview" src="images/request-scenarios/read-websocket/overview.png" /></p>

<p>The following diagram shows how the Request flows between the client application, the different Kuzzle components, and the external services:</p>

<p><img alt="read_scenario_websocket_details" src="images/request-scenarios/read-websocket/details.png" /></p>

<ul>
<li>The client application opens a Websocket connection to Kuzzle Proxy and emits a &ldquo;read&rdquo; event containing the request. For instance, to retrieve the document <code class="prettyprint">739c26bc-7a09-469a-803d-623c4045b0cb</code> in the collection <code class="prettyprint">users</code>:</li>
</ul>
<pre class="highlight json"><code><span class="p">{</span><span class="w">
  </span><span class="nt">"requestId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ed4faaff-253a-464f-a6b3-387af9d8483d"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"action"</span><span class="p">:</span><span class="w"> </span><span class="s2">"get"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"collection"</span><span class="p">:</span><span class="w"> </span><span class="s2">"users"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"739c26bc-7a09-469a-803d-623c4045b0cb"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>

<p>The client then listens to the <code class="prettyprint">&lt;requestId&gt;</code> event on the socket, like the following:</p>
<pre class="highlight javascript"><code>  <span class="k">this</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s2">"ed4faaff-253a-464f-a6b3-387af9d8483d"</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">callback</span><span class="p">(</span><span class="nx">response</span><span class="p">);</span>
  <span class="p">});</span>
</code></pre>

<ul>
<li>The Kuzzle Websocket plugin handles the Request and forwards the message to the Backend Broker.</li>
<li>The Backend Broker sends the message to the Proxy Broker (within the Kuzzle Core) through a Websocket connection.</li>
<li>The Proxy Broker forwards the Request through the Proxy Entry Point to the Router, who handles it and forwards the formatted Request to the Funnel.</li>
</ul>

<p>The formatted Request <code class="prettyprint">input</code> looks like the following:</p>
<pre class="highlight json"><code><span class="p">{</span><span class="w">
  </span><span class="nt">"controller"</span><span class="p">:</span><span class="w"> </span><span class="s2">"read"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"action"</span><span class="p">:</span><span class="w"> </span><span class="s2">"get"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"resource"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nt">"index"</span><span class="p">:</span><span class="w"> </span><span class="s2">"mainindex"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"collection"</span><span class="p">:</span><span class="w"> </span><span class="s2">"users"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"739c26bc-7a09-469a-803d-623c4045b0cb"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>

<ul>
<li>The Funnel validates the message and forward the request to the Document Controller.</li>
<li>The Document Controller forwards the Request <code class="prettyprint">input</code> to the Read Engine service.</li>
<li>The Read Engine service performs an HTTP request to get the data from Elasticsearch.</li>
</ul>

<p>The content returned by Elasticsearch looks like the following:</p>
<pre class="highlight json"><code><span class="p">{</span><span class="w">
  </span><span class="nt">"_index"</span><span class="p">:</span><span class="w"> </span><span class="s2">"mainindex"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"users"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"739c26bc-7a09-469a-803d-623c4045b0cb"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"_version"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
  </span><span class="nt">"found"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
  </span><span class="nt">"_source"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nt">"firstName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Grace"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"lastName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Hopper"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"age"</span><span class="p">:</span><span class="w"> </span><span class="mi">85</span><span class="p">,</span><span class="w">
      </span><span class="nt">"location"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nt">"lat"</span><span class="p">:</span><span class="w"> </span><span class="mf">32.692742</span><span class="p">,</span><span class="w">
          </span><span class="nt">"lon"</span><span class="p">:</span><span class="w"> </span><span class="mf">-97.114127</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nt">"city"</span><span class="p">:</span><span class="w"> </span><span class="s2">"NYC"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"hobby"</span><span class="p">:</span><span class="w"> </span><span class="s2">"computer"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>

<ul>
<li>Promises functions are resolved to forward the response message back to the Proxy Broker.</li>
<li>The Proxy Broker sends the response to the proxy&rsquo;s Backend Broker through the Websocket connection.</li>
<li>The Proxy triggers the callback, which emits a <code class="prettyprint">&lt;requestId&gt;</code> event to the Websocket client.</li>
</ul>

<h3 id="subscribing-and-writing-content-to-kuzzle">Subscribing and writing content to Kuzzle</h3>

<p>This section explains what happens when clients send new content to Kuzzle.</p>

<p>Kuzzle is able to handle two different types of input:</p>

<ul>
<li><strong>persisted data</strong>, via the <code class="prettyprint">_create_</code>, <code class="prettyprint">_createOrUpdate_</code>, or <code class="prettyprint">_delete_</code> actions.</li>
<li><strong>real-time data</strong>, via the <code class="prettyprint">_publish_</code> action.</li>
</ul>

<h4 id="writing-persistent-data">Writing persistent data</h4>

<p>This subsection describes the process for <strong>persistent</strong> data, with an example using the &ldquo;<em>create</em>&rdquo; action (see also <a href="/api-reference/#create48">API Documentation</a>).</p>

<p><img alt="persistence_overview" src="images/request-scenarios/persistence/overview.png" /></p>

<p>Detailed workflow:</p>

<p><img alt="persistence_scenario_details" src="images/request-scenarios/persistence/details.png" /></p>

<ul>
<li>A client sends new content to Kuzzle, either via an HTTP request, through a Websocket connection or using a custom plugin protocol.</li>
<li>The router handles the Request and forwards the message to the Funnel.</li>
</ul>
<pre class="highlight json"><code><span class="p">{</span><span class="w">
  </span><span class="nt">"status"</span><span class="p">:</span><span class="w"> </span><span class="mi">102</span><span class="p">,</span><span class="w">
  </span><span class="nt">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"..."</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">...</span><span class="w"> </span><span class="err">The</span><span class="w"> </span><span class="err">connection</span><span class="w"> </span><span class="err">id</span><span class="w">
  </span><span class="nt">"context"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="err">//</span><span class="w"> </span><span class="err">...</span><span class="w"> </span><span class="err">The</span><span class="w"> </span><span class="err">connection</span><span class="w"> </span><span class="err">context</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nt">"input"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nt">"resource"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nt">"index"</span><span class="p">:</span><span class="w"> </span><span class="s2">"mainindex"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"collection"</span><span class="p">:</span><span class="w"> </span><span class="s2">"users"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nt">"controller"</span><span class="p">:</span><span class="w"> </span><span class="s2">"document"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"action"</span><span class="p">:</span><span class="w"> </span><span class="s2">"create"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"body"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nt">"firstName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Grace"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"lastName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Hopper"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"age"</span><span class="p">:</span><span class="w"> </span><span class="mi">85</span><span class="p">,</span><span class="w">
      </span><span class="nt">"location"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nt">"lat"</span><span class="p">:</span><span class="w"> </span><span class="mf">32.692742</span><span class="p">,</span><span class="w">
        </span><span class="nt">"lon"</span><span class="p">:</span><span class="w"> </span><span class="mf">-97.114127</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nt">"city"</span><span class="p">:</span><span class="w"> </span><span class="s2">"NYC"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"hobby"</span><span class="p">:</span><span class="w"> </span><span class="s2">"computer"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>

<ul>
<li>The Funnel validates the Request and triggers the Plugins Manager with a <code class="prettyprint">document:create</code> event. The Plugins Manager calls all pipes and hooks configured by the active plugins (see the <a href="/plugin-reference/">Plugin Reference</a>).</li>
<li>The Funnel forwards the Request to the Document Controller.</li>
<li>The Document Controller sends the request to the Storage Engine service.
The Storage Engine sends the request to the database.</li>
<li>Once the Storage Engine gets the response back, it replies to the Document Controller.</li>
<li>The Document Controller wraps the response in a Kuzzle Response and forwards it back to the user.</li>
</ul>

<h4 id="subscribe-and-notification-scenario">Subscribe and Notification scenario</h4>

<p>This subsection describes the life-cycle of <strong>non persistent</strong> data notifications as well as real-time notifications, implementing the <a href="https://en.wikipedia.org/wiki/Publish%E2%80%93subscribe_pattern">Publish/Subscribe pattern</a>.</p>

<p>Remember the <a href="#kuzzle-in-depth">Architecture overview</a> and focus on the components involved by pub/sub actions:
<img alt="pubsub_overview" src="images/request-scenarios/pubsub/overview.png" /></p>

<h5 id="1st-step-subscription">1st step: subscription</h5>

<p>The following diagram shows how two different clients, a Websocket and a MQ one, subscribe to data.</p>

<p><img alt="pubsub_scenario_details1" src="images/request-scenarios/pubsub/details1.png" /></p>

<ul>
<li>The client application opens a Websocket or a MQ connection and emits a &ldquo;subscribe&rdquo; event with some filters (see the <a href="/api-reference/#subscribe">API Documentation</a>). For instance, to be notified about all contents posted to the collection <code class="prettyprint">users</code>, containing a field <code class="prettyprint">hobby</code> equals to <code class="prettyprint">computer</code>:</li>
</ul>
<pre class="highlight json"><code><span class="p">{</span><span class="w">
  </span><span class="nt">"requestId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ed4faaff-253a-464f-a6b3-387af9d8483d"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"index"</span><span class="p">:</span><span class="w"> </span><span class="s2">"mainindex"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"collection"</span><span class="p">:</span><span class="w"> </span><span class="s2">"users"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"action"</span><span class="p">:</span><span class="w"> </span><span class="s2">"on"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"body"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nt">"equals"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nt">"hobby"</span><span class="p">:</span><span class="w"> </span><span class="s2">"computer"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nt">"state"</span><span class="p">:</span><span class="w"> </span><span class="s2">"all"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>

<p>See the <a href="/real-time-filters/">Real-time Filters Reference</a> for more details.</p>

<p>The client then listens to the <code class="prettyprint">&lt;requestId&gt;</code> event on the socket.
Kuzzle will get back to him with a corresponding Room ID and a Room Channel using this event.</p>

<p>Sample Javascript code, using Websocket:</p>
<pre class="highlight javascript"><code>  <span class="k">this</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s2">"ed4faaff-253a-464f-a6b3-387af9d8483d"</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">callback</span><span class="p">(</span><span class="nx">response</span><span class="p">);</span>
  <span class="p">});</span>
</code></pre>

<ul>
<li>The Router interprets the input request and transfer the subscription message to the Funnel.</li>
</ul>
<pre class="highlight json"><code><span class="p">{</span><span class="w">
  </span><span class="nt">"index"</span><span class="p">:</span><span class="w"> </span><span class="s2">"mainindex"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"collection"</span><span class="p">:</span><span class="w"> </span><span class="s2">"users"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"controller"</span><span class="p">:</span><span class="w"> </span><span class="s2">"subscribe"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"action"</span><span class="p">:</span><span class="w"> </span><span class="s2">"on"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"filter"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nt">"equals"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nt">"hobby"</span><span class="p">:</span><span class="w"> </span><span class="s2">"computer"</span><span class="w"> </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>

<ul>
<li>The Funnel validates the message and transfers it to the Realtime Controller.</li>
<li>The Realtime Controller calls the HotelClerk internal component to create the subscription.</li>
<li>The HotelClerk calls the DSL component to get a formated filter related to the subscription (see <a href="https://github.com/kuzzleio/kuzzle/blob/master/lib/api/dsl/README.md">DSL Readme</a> for more details).</li>
<li>The HotelClerk creates a channel related to the filters and gives it back to the Realtime Controller.</li>
<li>The channel is sent back to the Websocket (or MQ) Router through the internal components.</li>
<li>The Websocket (or MQ) Router emits a <code class="prettyprint">&lt;requestId&gt;</code> event to the client, containing the subscribed channel ID.</li>
</ul>

<p>Sample response content:</p>
<pre class="highlight json"><code><span class="p">{</span><span class="w">
  </span><span class="nt">"status"</span><span class="p">:</span><span class="w"> </span><span class="mi">200</span><span class="p">,</span><span class="w">
  </span><span class="nt">"error"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
  </span><span class="nt">"index"</span><span class="p">:</span><span class="w"> </span><span class="s2">"mainindex"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"collection"</span><span class="p">:</span><span class="w"> </span><span class="s2">"users"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"controller"</span><span class="p">:</span><span class="w"> </span><span class="s2">"subscribe"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"action"</span><span class="p">:</span><span class="w"> </span><span class="s2">"on"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"state"</span><span class="p">:</span><span class="w"> </span><span class="s2">"all"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"requestId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ed4faaff-253a-464f-a6b3-387af9d8483d"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"result"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nt">"roomId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"78c5b0ba-fead-4535-945c-8d64a7927459"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"channel"</span><span class="p">:</span><span class="w"> </span><span class="s2">"c5cd8bdc-06a4-4d6e-bae3-61f1a8ac2982"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>

<ul>
<li>The client now listens to this <code class="prettyprint">channel</code> events to be notified about new messages corresponding to his subscription filters.</li>
</ul>

<h5 id="2nd-step-notify-about-real-time-actions">2nd step : notify about real-time actions</h5>

<p>The following diagram shows how Kuzzle handles a new message and how subscribed clients are notified:</p>

<p><img alt="pubsub_scenario_details2" src="images/request-scenarios/pubsub/details2.png" /></p>

<ul>
<li>A new content is published to the Notifier component. The <code class="prettyprint">_publish_</code> method can be triggered:

<ul>
<li>either directly by the Document Controller for non persistent data (using the <a href="/api-reference/#publish">publish</a> action).</li>
<li>or by the Plugins Manager when a &#39;document:create&rsquo; event is triggered, to notify users in real-time before the data are sent to the storage Engine.</li>
</ul></li>
<li>The Notifier calls the DSL component to test registered filters that match the content, and get related rooms.</li>
<li>The Notifier uses the Notification Cache engine to store the mapping content/rooms into cache.</li>
<li>The Notifier calls the HotelClerk to get the channels related to the rooms.</li>
<li>The Notifier broadcasts the message to each related channel to the Websocket and MQ plugins.</li>
<li>Finally, the plugins send the message to the clients who subscribed to it.</li>
</ul>

<h5 id="3rd-step-notify-about-persisted-data">3rd step : notify about persisted data</h5>

<p><img alt="pubsub_scenario_details2" src="images/request-scenarios/pubsub/details3.png" /></p>

<ul>
<li>The Notifier component is notified about a new action by the Document Controller (see <a href="#writing-persistent-data">write scenario</a>).</li>
<li>The Notifier calls the Notification Cache to get the rooms related to the content.</li>
<li>The Notifier calls the HotelClerk to get the channels related to the rooms.</li>
<li>The Notifier broadcasts the message to each related channel to the Websocket and MQ plugins.</li>
<li>Finally, the plugins send the message to the clients who subscribed to it.</li>
</ul>

            <h2 id="authentication">Authentication</h2>

<p>Kuzzle uses <a href="http://PassportJS.org/">PassportJS</a> to enable authentication through a large amount of providers, for example:</p>

<ul>
<li>local username/password authentication (enabled by default)</li>
<li>OAuth2 providers like GitHub or google (using (Oauth plugin)[https://GitHub.com/kuzzleio/kuzzle-plugin-auth-passport-oauth])</li>
<li>SAML providers</li>
</ul>

<p>Remember the <a href="#core-architecture">Architecture overview</a> and focus on the components involved by reading actions:
<img alt="read_scenario_http_overview" src="images/request-scenarios/auth/overview.png" /></p>

<p>Kuzzle uses the following internal components during the authentication process:</p>

<ul>
<li>The Auth Controller.</li>
<li>The Passport Wrapper, which acts as an interface between Kuzzle controllers and the Passport library,</li>
<li>The User and Token <a href="https://GitHub.com/kuzzleio/kuzzle/tree/master/lib/api/core/models/repositories">Repositories</a>, to retrieve users&rsquo; data.</li>
<li>The Authentication strategy, implemented within a dedicated plugin.</li>
</ul>

<h3 id="example-local-strategy">Example - Local Strategy</h3>

<p>The &ldquo;Local&rdquo; strategy (implemented by the <a href="https://GitHub.com/kuzzleio/kuzzle-plugin-auth-passport-local">Passport Local Plugin</a>) authenticates a user via a username/password pair (locally stored).</p>

<p><img alt="auth_scenario_details_local" src="images/request-scenarios/auth/details-local.png" /></p>

<ul>
<li>The user calls the <code class="prettyprint">login</code> action of the Auth Controller:</li>
</ul>
<pre class="highlight plaintext"><code>{
  "controller": "auth",
  "action": "login",
  "body": {
    "strategy": "local",
    "username": "&lt;my_username&gt;",
    "password": "&lt;my_password&gt;"
  }
}
</code></pre>

<ul>
<li>The Auth Controller calls the <code class="prettyprint">authenticate()</code> method of the Passport Wrapper which formats and sends the related request to the Passport local strategy.</li>
<li>The Passport local strategy calls the <code class="prettyprint">verify()</code> callback method declared by the Local Authentication Plugin to check credentials.</li>
<li>The plugin calls the User Repository and check if credentials are good and resolve to an existing user.</li>
<li>If a user is found, he is resolved and sent back to the Auth Controller through the internal components.</li>
<li>The Auth Controller calls the <code class="prettyprint">generateToken()</code> method to get a <a href="https://jwt.io/">JWT Token</a> corresponding to the user.</li>
<li>The JWT Token is sent back to the client, who will use it in next requests to be authenticated:</li>
</ul>

<p>Sample response:</p>
<pre class="highlight plaintext"><code>{
  "status": 200,
  "error": null,
  "controller": "auth",
  "action": "login",
  "state": "done",
  "requestId": "ed4faaff-253a-464f-a6b3-387af9d8483d",
  "metadata": {},
  "result": {
    "_id": "my_username",
    "jwt": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJteV91c2VybmFtZSIsIm5hbWUiOiJKb2huIERvZSIsImFkbWluIjp0cnVlfQ.BefoyfAKzwXuGhbYe0iPeG0v9F4HmikvahqwqzQr3pE"
  }
}
</code></pre>

<h3 id="example-oauth2-strategy">Example - OAuth2 Strategy</h3>

<p>The &ldquo;Oauth&rdquo; strategy, implemented by the <a href="https://GitHub.com/kuzzleio/kuzzle-plugin-auth-passport-oauth">Passport Oauth Plugin</a>, authenticates a user  via Github, Google+, Facebook, Twitter, or any identity provider using OAUth2 protocol with &ldquo;Authorization Code&rdquo; grant type.</p>

<p>For more details about OAuth2 protocol, see <a href="https://www.digitalocean.com/community/tutorials/an-introduction-to-oauth-2#grant-type-authorization-code">here</a>.</p>

<p><img alt="auth_scenario_details_oauth2" src="images/images/request-scenarios/auth/details-OAuth2.png" /></p>

<p>The authentication flow is a 2-step flow:</p>

<h4 id="1st-step-get-the-oauth2-provider-39-s-url">1st step: get the OAuth2 Provider&rsquo;s URL</h4>

<ul>
<li>The user calls the <code class="prettyprint">login</code> action of the Auth Controller:</li>
</ul>
<pre class="highlight plaintext"><code>{
  "controller": "auth",
  "action": "login",
  "body": {
    "strategy": "GitHub"
  }
}
</code></pre>

<ul>
<li>The Auth Controller calls the <code class="prettyprint">authenticate()</code> method of the Passport Wrapper which formats and sends the related request to the Passport OAuth2 strategy.</li>
<li>The strategy calls a redirection to the OAuth2 Provider.</li>
<li>The Passport Wrapper intercepts the redirection request and formats a Kuzzle Response for the client:</li>
</ul>
<pre class="highlight plaintext"><code>{
  "headers":
  {
    "Content-Length": "0",
    "Location": "https://GitHub.com/login/oauth/authorize?response_type=code&amp;redirect_uri=http%3A%2F%2Fkuzzle%2Fapi%2F1.0%2F_login%2Fgithub&amp;client_id=MY_CLIENT_ID"
  },
  "statusCode": 302
}
</code></pre>

<ul>
<li>The Auth Controller sends the response to the client, with the redirection URL to the OAUth2 Provider:</li>
</ul>
<pre class="highlight plaintext"><code>{
  "action": "login",
  "controller": "auth",
  "error": null,
  "metadata": {},
  "requestId": "fd4246f9-717c-4503-b50b-3a5bf0f142b5",
  "result": {
    "headers": {
      "Content-Length": "0",
      "Location": "https://GitHub.com/login/oauth/authorize?response_type=code&amp;redirect_uri=http%3A%2F%2Fkuzzle%2Fapi%2F1.0%2F_login%2Fgithub&amp;client_id=MY_CLIENT_ID"
    },
    "statusCode": 302
  },
  "scope": null,
  "state": "done",
  "status": 200
}
</code></pre>

<h4 id="2nd-step-authenticate-the-user-with-the-oauth2-code">2nd step: authenticate the user with the OAuth2 code.</h4>

<ul>
<li>The Client sends an HTTP request to the OAuth2 Provider (unless you are using a Kuzzle SDK, this has to be implemented within the client&rsquo;s application code).</li>
<li>The user authenticates to the OAuth2 Provider and allow Kuzzle Application to use his credentials (that is the standard OAuth2 flow, managed at the provider&rsquo;s side).</li>
<li>The OAuth2 Provider sends a HTTP redirect response to the client, containing the OAuth2 authorization code:</li>
</ul>
<pre class="highlight plaintext"><code>HTTP/1.1 302 Found
Location: http://&lt;kuzzle&gt;/_login/GitHub?code=OAUTH2_CODE
</code></pre>

<ul>
<li>The client calls again the <code class="prettyprint">login</code> action of the Auth Controller, now with the OAuth2 authorization code:

<ul>
<li>either in HTTP, simply following the redirection <code class="prettyprint">curl http://&lt;kuzzle&gt;/_login/GitHub?code=OAUTH2_CODE</code></li>
<li>or, with another protocol (for example WebSocket), after having parsed the URL to get the authorization code:</li>
</ul></li>
</ul>
<pre class="highlight plaintext"><code>{
  "controller": "auth",
  "action": "login",
  "body": {
    "strategy": "GitHub",
    "code": "OAUTH2_CODE"
  }
}
</code></pre>

<ul>
<li>The Auth Controller calls the <code class="prettyprint">authenticate()</code> method of the Passport Wrapper which formats and sends the related request to the Passport OAuth2 strategy.</li>
<li>The Passport OAuth2 strategy forwards the OAuth2 authorization code to the OAuth2 Provider in order to retrieve the OAuth2 Token.</li>
<li>The Passport OAuth2 strategy calls the <code class="prettyprint">verify()</code> callback method declared by the OAuth2 Authentication Plugin</li>
<li>The plugin calls the User Repository to check for an existing user with the given GitHub ID. <em>(Note: If no related user is found in Kuzzle, the plugin can either deny the authentication or create automatically the user, depending on the settings).</em></li>
<li>The user is resolved and sent back to the Auth Controller through the internal components.</li>
<li>The Auth Controller calls the <code class="prettyprint">generateToken()</code> method to get a <a href="https://jwt.io/">JWT Token</a> related to the user.</li>
<li>The JWT Token is sent back to the client, who will use it in next requests to be authenticated.</li>
</ul>

<h4 id="how-to-provide-your-own-strategy">How to provide your own strategy</h4>

<p>Any strategy supported by PassportJS can be implemented in Kuzzle with a dedicated plugin. Please refer to the <a href="/plugin-reference/#authentication-plugin">Plugins Reference</a>).</p>

<h3 id="advanced-roles-definitions">Advanced Roles Definitions</h3>

<p>In the <a href="#permissions">User Guide</a>, we have seen how to assign basic roles to profiles and profiles to users. Here, we are going to learn how to set complex and dynamic permissions.</p>

<p>The privileges for a certain action (restricted to a given set of indexes and collections) must be expressed as a boolean value. So far, we hard-coded this value within the permissions configuration. In some cases, this will not fit your needs. In a collaborative TO-DO list application, for example, a user should not be allowed to update other user&rsquo;s items. This need is addressed by what we call Permission Closures.</p>

<h4 id="permission-closures">Permission Closures</h4>

<p>Instead of hard-coding the permission boolean value, we assign a function (a closure) that computes this value and returns it based on the execution context.</p>

<p>For example, if we need to allow users to update only their own documents, it can be done with this sample role:</p>
<pre class="highlight javascript"><code><span class="kd">let</span> <span class="nx">role</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">controllers</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">write</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">actions</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">update</span><span class="p">:</span> <span class="p">{</span>
          <span class="na">args</span><span class="p">:</span> <span class="p">{</span>
            <span class="na">document</span><span class="p">:</span> <span class="p">{</span>
              <span class="na">index</span><span class="p">:</span> <span class="s2">"$request.input.resource.index"</span><span class="p">,</span>
              <span class="na">collection</span><span class="p">:</span> <span class="s2">"$request.input.resource.collection"</span><span class="p">,</span>
              <span class="na">action</span><span class="p">:</span> <span class="p">{</span>
                <span class="na">get</span><span class="p">:</span> <span class="s2">"$currentId"</span>
              <span class="p">}</span>
            <span class="p">}</span>
          <span class="p">},</span>
          <span class="na">test</span><span class="p">:</span> <span class="s2">"return args.document.content.user.id === $currentUserId"</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">};</span>
</code></pre>

<p>Where:</p>

<ul>
<li><code class="prettyprint">test</code> is the body of <a href="#the-permission-function">the permission function</a></li>
<li><code class="prettyprint">args</code> is the parameter given to <a href="#the-fetch-definition">the fetch definition function</a></li>
</ul>

<h4 id="the-permission-function">The permission function</h4>

<p>The permission function is executed in a sandbox with a limited context. Its body is the evaluation of the <code class="prettyprint">test</code> parameter given in the role&rsquo;s definition and <strong>must return a boolean value</strong>.</p>

<p>The permission function has the following signature:</p>
<pre class="highlight javascript"><code><span class="cm">/**
 * @param {Request} $request              The current action request.
 * @param {string} $currentUserId         The current user Id. Shortcut to request.context.token.userId
 * @param {Object} args                   The result of the evaluated args definition.
 *
 * @return {Boolean}
 */</span>
<span class="kd">function</span> <span class="p">(</span><span class="nx">$request</span><span class="p">,</span> <span class="nx">$currentUserId</span><span class="p">,</span> <span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// the function body is built from the "test" parameter.</span>
  <span class="c1">// Example, with the sample role above:</span>
  <span class="k">return</span> <span class="nx">args</span><span class="p">.</span><span class="nb">document</span><span class="p">.</span><span class="nx">content</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">id</span> <span class="o">===</span> <span class="nx">$currentUserId</span><span class="p">;</span>
<span class="p">};</span>
</code></pre>

<h5 id="request">$request</h5>

<p>The <a href="https://github.com/kuzzleio/kuzzle-common-objects#request">Request</a> object is the request that is currently being evaluated.  </p>

<h5 id="currentuserid">$currentUserId</h5>

<p>The <code class="prettyprint">$currentUserId</code> variable contains the current user ID. It is an alias for <code class="prettyprint">request.context.token.userId</code>.</p>

<h5 id="args">args</h5>

<p>The main purpose of the &ldquo;closures&rdquo; behavior is to define a role policy based on the current state of the persistence layer. This means that we need to fetch documents from the storage engine in order to use them within the permission function.</p>

<p>The <code class="prettyprint">args</code> object contains these documents, as a result of the evaluation of the <a href="#the-fetch-definition">fetch definition</a>.
Each <code class="prettyprint">args</code> item will look like:</p>
<pre class="highlight javascript"><code><span class="p">{</span>
  <span class="nl">content</span><span class="p">:</span> <span class="o">&lt;</span><span class="nx">the</span> <span class="nb">document</span> <span class="nx">itself</span><span class="o">&gt;</span><span class="p">,</span>
  <span class="nx">id</span><span class="err">:</span> <span class="o">&lt;</span><span class="nx">the</span> <span class="nb">document</span> <span class="nx">id</span><span class="o">&gt;</span>
<span class="p">}</span>
</code></pre>

<p>In the sample role above (<code class="prettyprint">return args.document.content.user.id === $currentUserId</code>), the <code class="prettyprint">update</code> action is allowed only if the fetched document contains an attribute <code class="prettyprint">user.id</code> which value is the current user ID.</p>

<h4 id="the-fetch-definition">The Fetch Definition</h4>

<p>The Fetch Definition allows you to pass some documents fetched from the persistence layer to your permission function.</p>

<p>In our sample role above, we fetch a <code class="prettyprint">document</code> variable which contains the document that was requested for update, and we use it in the permission function to test if it is owned by the current user.</p>

<h5 id="args-element-structure">args element structure</h5>

<p>The <code class="prettyprint">args</code> element is the place where we define our Fetch Definitions and has the following structure:</p>
<pre class="highlight json"><code><span class="p">{</span><span class="w">
  </span><span class="nt">"args"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nt">"&lt;some variable&gt;"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nt">"index"</span><span class="p">:</span><span class="w"> </span><span class="err">&lt;index</span><span class="w"> </span><span class="err">from</span><span class="w"> </span><span class="err">which</span><span class="w"> </span><span class="err">to</span><span class="w"> </span><span class="err">fetch</span><span class="w"> </span><span class="err">the</span><span class="w"> </span><span class="err">document(s)&gt;</span><span class="p">,</span><span class="w">
      </span><span class="nt">"collection"</span><span class="p">:</span><span class="w"> </span><span class="err">&lt;collection</span><span class="w"> </span><span class="err">from</span><span class="w"> </span><span class="err">which</span><span class="w"> </span><span class="err">to</span><span class="w"> </span><span class="err">fetch</span><span class="w"> </span><span class="err">the</span><span class="w"> </span><span class="err">document(s)&gt;</span><span class="p">,</span><span class="w">
      </span><span class="nt">"action"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nt">"&lt;action type (get|mget|search)&gt;"</span><span class="p">:</span><span class="w"> </span><span class="err">&lt;action</span><span class="w"> </span><span class="err">type</span><span class="w"> </span><span class="err">specific</span><span class="w"> </span><span class="err">parameters&gt;</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nt">"&lt;another variable&gt;"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="err">...</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="err">...</span><span class="w">
  </span><span class="err">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>

<p>You can define one or more variables inside the args element and, for each of them, the action to use to populate them. Each variable will then be available in <a href="#the-permission-function">your permission function</a> as <code class="prettyprint">args.&lt;variable&gt;</code>.</p>

<h5 id="embedded-variables">Embedded variables</h5>

<p>Some variables are exposed by Kuzzle and can be used within your Fetch  Definition:</p>

<ul>
<li><code class="prettyprint">$request</code>: The complete request object being evaluated.</li>
<li><code class="prettyprint">$currentId</code>: The current request document ID. It is an alias for <code class="prettyprint">$request.input.resource._id</code>.</li>
</ul>

<h5 id="action-types">action types</h5>

<h6 id="get"><code class="prettyprint">get</code></h6>

<p>The <code class="prettyprint">get</code> action type performs a read/get call. It fetches a document by its ID.</p>

<p>Example:</p>
<pre class="highlight json"><code><span class="p">{</span><span class="w">
  </span><span class="nt">"args"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nt">"currentDocument"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nt">"index"</span><span class="p">:</span><span class="w"> </span><span class="s2">"$request.input.resource.index"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"collection"</span><span class="p">:</span><span class="w"> </span><span class="s2">"$request.input.resource.collection"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"action"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nt">"get"</span><span class="p">:</span><span class="w"> </span><span class="s2">"$currentId"</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nt">"anotherDocument"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nt">"index"</span><span class="p">:</span><span class="w"> </span><span class="s2">"myIndex"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"collection"</span><span class="p">:</span><span class="w"> </span><span class="s2">"myCollection"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"action"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nt">"get"</span><span class="p">:</span><span class="w"> </span><span class="s2">"document_id"</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>

<p>In the <code class="prettyprint">args</code> field, we declare the following Fetch Definitions:</p>

<ul>
<li><code class="prettyprint">currentDocument</code>, which represents the document that the user wants to update and whose Fetch Definition is composed of:

<ul>
<li><code class="prettyprint">index</code>: the index pointed by the current Request;</li>
<li><code class="prettyprint">collection</code>: the collection pointed by the current Request;</li>
<li><code class="prettyprint">$currentId</code>: the document ID pointed by the current Request, passed as an argument to the <code class="prettyprint">get</code> action.</li>
</ul></li>
<li><code class="prettyprint">anotherDocument</code>, which represents another document, just as an example, fetched the same way as the previous one but with different parameters.</li>
</ul>

<h6 id="mget"><code class="prettyprint">mget</code></h6>

<p>The <code class="prettyprint">mget</code> action type takes a list of document ids for entry and returns the list of matching documents.</p>
<pre class="highlight json"><code><span class="p">{</span><span class="w">
  </span><span class="nt">"args"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nt">"myDocuments"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nt">"index"</span><span class="p">:</span><span class="w"> </span><span class="s2">"myIndex"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"collection"</span><span class="p">:</span><span class="w"> </span><span class="s2">"myCollection"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"action"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nt">"mget"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
          </span><span class="s2">"id_1"</span><span class="p">,</span><span class="w">
          </span><span class="s2">"id_2"</span><span class="p">,</span><span class="w">
          </span><span class="err">...</span><span class="w">
        </span><span class="p">]</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>

<p>In the <code class="prettyprint">args</code> field, we declare a multi-valued Fetch Definition. Notice how the <code class="prettyprint">mget</code> action takes an array of IDs rather than a single value.</p>

<p>These documents are accessed in the Permission Function as follows:</p>
<pre class="highlight javascript"><code><span class="nx">args</span><span class="p">.</span><span class="nx">myDocuments</span> <span class="o">=</span> <span class="p">[</span>
  <span class="p">{</span> <span class="na">id</span><span class="p">:</span> <span class="s2">"id_1"</span><span class="p">,</span> <span class="na">content</span><span class="p">:</span> <span class="p">{</span><span class="na">name</span><span class="p">:</span> <span class="s2">"Document 1"</span><span class="p">,</span> <span class="na">description</span><span class="p">:</span> <span class="s2">"Cum sociis natoque penatibus et magnis dis parturient montes"</span><span class="p">},</span>
  <span class="p">}</span>
  <span class="p">{</span> <span class="nl">id</span><span class="p">:</span> <span class="s2">"id_2"</span><span class="p">,</span> <span class="nx">content</span><span class="err">:</span> <span class="p">{</span><span class="nl">name</span><span class="p">:</span> <span class="s2">"Document 2"</span><span class="p">,</span> <span class="nx">description</span><span class="err">:</span> <span class="s2">"nascetur ridiculus mus. Nulla nunc velit"</span><span class="p">},</span>
  <span class="p">}</span>
  <span class="p">...</span>
<span class="p">]</span>
</code></pre>

<h6 id="search"><code class="prettyprint">search</code></h6>

<p>The <code class="prettyprint">search</code> action type performs a search on the persistence layer and returns the resulting documents. It behave exactly like a normal <a href="#document-search">document search</a>.</p>

<p>Example:</p>
<pre class="highlight json"><code><span class="p">{</span><span class="w">
  </span><span class="nt">"args"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nt">"myDocuments"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nt">"index"</span><span class="p">:</span><span class="w"> </span><span class="s2">"myIndex"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"collection"</span><span class="p">:</span><span class="w"> </span><span class="s2">"myCollection"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"action"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nt">"search"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nt">"filter"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nt">"match"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
              </span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"$request.input.body.name"</span><span class="w">
            </span><span class="p">}</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">  
</span><span class="p">}</span><span class="w">
</span></code></pre>

<p>The search results are available in the Permission Function as an array of documents fetched from <code class="prettyprint">myIndex</code>/<code class="prettyprint">myCollection</code>, for which the <code class="prettyprint">name</code> attribute matches the <code class="prettyprint">name</code> attribute of the request:</p>
<pre class="highlight javascript"><code><span class="nx">args</span><span class="p">.</span><span class="nx">myDocuments</span> <span class="o">=</span> <span class="p">[</span>
  <span class="p">{</span> <span class="na">id</span><span class="p">:</span> <span class="s2">"id_1"</span><span class="p">,</span> <span class="na">content</span><span class="p">:</span> <span class="p">{</span><span class="na">name</span><span class="p">:</span> <span class="s2">"foo"</span><span class="p">,</span> <span class="na">description</span><span class="p">:</span> <span class="s2">"Cum sociis natoque penatibus et magnis dis parturient montes"</span><span class="p">},</span>
  <span class="p">}</span>
  <span class="p">{</span> <span class="nl">id</span><span class="p">:</span> <span class="s2">"id_2"</span><span class="p">,</span> <span class="nx">content</span><span class="err">:</span> <span class="p">{</span><span class="nl">name</span><span class="p">:</span> <span class="s2">"foo bar"</span><span class="p">,</span> <span class="nx">description</span><span class="err">:</span> <span class="s2">"nascetur ridiculus mus. Nulla nunc velit"</span><span class="p">},</span>
  <span class="p">}</span>
  <span class="p">...</span>
<span class="p">]</span>
</code></pre>

<p>The content of <code class="prettyprint">action.search</code> is directly passed to Elasticsearch.</p>

<p>Please refer to <a href="/elasticsearch-cookbook/">our Elasticsearch Cookbook</a> for additional information on how to build your query.</p>

        </div>
        <div class="dark-box">
        </div>
      </div>
    </div>
    <script>
      ((window.gitter = {}).chat = {}).options = {
        room: 'kuzzleio/kuzzle'
      };
    </script>
    <script src="https://sidecar.gitter.im/dist/sidecar.v1.js" async defer></script>
    <script type="text/javascript">
      (function(i, s, o, g, r, a, m) {
          i['GoogleAnalyticsObject'] = r;
          i[r] = i[r] || function() {
                  (i[r].q = i[r].q || []).push(arguments)
              }, i[r].l = 1 * new Date();
          a = s.createElement(o),
              m = s.getElementsByTagName(o)[0];
          a.async = 1;
          a.src = g;
          m.parentNode.insertBefore(a, m)
      })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');

      ga('create', 'UA-67035328-1', 'auto');
      ga('send', 'pageview');


      (function() {
        var
          r,
          version;

        r = /\/v\/([^/]+)(?:\/[^/]+\.html?)?$/.exec(window.location.pathname);

        if (r) {
          version = r[1];
          $('#version-selector option[value="/v/' + version + '"]').prop('selected', true);
        }

        $('#version-selector').change(function (e) {
          var
            versionPath = $('#version-selector option:selected').val();
          window.location = window.location.pathname
            .replace(/\/v\/([^/]+)(\/[^/]+\.html?)?$/, '\2')
            + versionPath
            +'#' + window.location.hash;
        });
      })();
    </script>
  </body>
</html>
